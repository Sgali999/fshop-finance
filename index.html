<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Mani Finance</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=IBM+Plex+Serif:wght@600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{
  --g1:#1B5E20;--g2:#2E7D32;--g3:#388E3C;
  --gl:#C8E6C9;--gp:#E8F5E9;--gr:#F1F8E9;
  --y1:#F9A825;--y2:#FDD835;
  --r1:#C62828;--rp:#FFEBEE;
  --b1:#1565C0;--bp:#E3F2FD;
  --bg:#F4F5EF;--txt:#1B3A1C;--txt2:#4A6B4C;--txt3:#7A9E7C;--txt4:#B8D4BA;
  --bdr:#C8E6C9;--bdr2:#A5D6A7;
  --shadow2:0 4px 24px rgba(27,94,32,0.13);
  --r:10px;--sb:222px;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--txt);font-size:14px;line-height:1.5;}
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-thumb{background:var(--gl);border-radius:3px;}

/* LOGIN */
#loginScreen{min-height:100vh;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--g1) 0%,var(--g2) 60%,#43A047 100%);}
.lc{width:360px;background:#fff;border-radius:20px;padding:40px 36px;box-shadow:0 24px 60px rgba(0,0,0,0.2);}
.lc-icon{width:60px;height:60px;background:linear-gradient(135deg,var(--g1),var(--g3));border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:26px;margin:0 auto 14px;box-shadow:0 4px 16px rgba(27,94,32,0.3);}
.lc h1{font-family:'IBM Plex Serif',serif;font-size:22px;color:var(--g1);text-align:center;}
.lc p{font-size:10px;color:var(--txt3);letter-spacing:2px;text-transform:uppercase;margin:3px 0 24px;text-align:center;}
.lbl{display:block;font-size:10px;font-weight:600;color:var(--txt2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.inp{width:100%;background:var(--gp);border:1.5px solid var(--bdr);border-radius:8px;padding:11px 13px;color:var(--txt);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s;margin-bottom:14px;}
.inp:focus{border-color:var(--g2);background:#fff;}
.inp::placeholder{color:var(--txt4);}
.btn-login{width:100%;background:linear-gradient(135deg,var(--g1),var(--g3));color:#fff;font-weight:700;font-size:14px;border:none;border-radius:8px;padding:13px;cursor:pointer;font-family:inherit;}
.btn-login:hover{filter:brightness(1.08);}
.lerr{color:var(--r1);font-size:12px;text-align:center;margin-top:10px;min-height:18px;}

/* LAYOUT */
#app{display:none;height:100vh;overflow:hidden;}
.aw{display:flex;height:100%;}

/* SIDEBAR */
.sb{width:var(--sb);background:var(--g1);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto;}
.sb-top{padding:16px 13px 10px;}
.sb-brand{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:9px;background:rgba(255,255,255,.09);margin-bottom:9px;}
.sb-bi{width:34px;height:34px;background:var(--y2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.sb-bt h2{font-family:'IBM Plex Serif',serif;font-size:14px;color:#fff;}
.sb-bt p{font-size:8px;color:rgba(255,255,255,.45);letter-spacing:1.5px;text-transform:uppercase;}
.sb-usr{margin:0 13px 9px;background:rgba(255,255,255,.09);border-radius:8px;padding:9px 11px;display:flex;align-items:center;gap:8px;}
.sb-av{width:30px;height:30px;border-radius:50%;background:var(--y2);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:var(--g1);flex-shrink:0;}
.sb-un{font-size:12px;font-weight:600;color:#fff;}
.sb-ur{font-size:9px;color:rgba(255,255,255,.45);}
.sb-nav{padding:5px 9px;flex:1;}
.ng{font-size:8px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;padding:11px 8px 3px;}
.ni{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;cursor:pointer;font-size:12px;font-weight:500;color:rgba(255,255,255,.6);margin-bottom:1px;transition:all .15s;user-select:none;position:relative;}
.ni:hover{background:rgba(255,255,255,.1);color:#fff;}
.ni.active{background:rgba(255,255,255,.16);color:#fff;font-weight:600;}
.ni.active::before{content:'';position:absolute;left:0;width:3px;height:22px;background:var(--y2);border-radius:0 3px 3px 0;}
.ni svg{width:13px;height:13px;flex-shrink:0;opacity:.7;}
.ni.active svg{opacity:1;}
.sb-bot{padding:11px 13px;border-top:1px solid rgba(255,255,255,.1);margin-top:auto;}
.btn-out{width:100%;background:transparent;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.55);border-radius:7px;padding:8px;font-size:11px;font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;}
.btn-out:hover{background:var(--r1);border-color:var(--r1);color:#fff;}

/* MAIN */
.mw{flex:1;overflow-y:auto;background:var(--bg);}
.main{padding:22px 26px;max-width:1440px;}

/* MOBILE HEADER - z-index must be highest */
.mob-hdr{display:none;position:fixed;top:0;left:0;right:0;background:var(--g1);z-index:1000;padding:10px 15px;align-items:center;justify-content:space-between;}
.mob-brand{font-family:'IBM Plex Serif',serif;font-size:15px;color:#fff;display:flex;align-items:center;gap:7px;}
.mob-bi{width:27px;height:27px;background:var(--y2);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;}
.ham{background:rgba(255,255,255,.15);border:none;border-radius:8px;width:38px;height:38px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:5px;cursor:pointer;padding:0;flex-shrink:0;}
.ham span{display:block;width:18px;height:2px;background:#fff;border-radius:2px;pointer-events:none;}

/* MOBILE BOTTOM NAV */
.mob-nav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--g1);border-top:1px solid rgba(255,255,255,.1);z-index:1000;padding:5px 0 10px;gap:0;}
.mi{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;padding:5px 2px;cursor:pointer;font-size:7px;font-weight:600;color:rgba(255,255,255,.45);transition:color .15s;text-transform:uppercase;letter-spacing:.4px;}
.mi.active{color:var(--y2);}
.mi svg{width:16px;height:16px;}

/* SIDE DRAWER - slides from left */
#sideDrawer{position:fixed;top:0;left:-100%;bottom:0;width:78%;max-width:300px;background:var(--g1);z-index:2000;overflow-y:auto;transition:left .28s cubic-bezier(.4,0,.2,1);box-shadow:4px 0 30px rgba(0,0,0,0.3);}
#sideDrawer.open{left:0;}
#drawerOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:1999;}
#drawerOverlay.open{display:block;}
.dr-hdr{padding:18px 16px 14px;border-bottom:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:space-between;}
.dr-close{background:rgba(255,255,255,.1);border:none;color:#fff;width:32px;height:32px;border-radius:7px;font-size:17px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.dr-body{padding:8px 10px;}
.dr-sec{font-size:8px;font-weight:700;color:rgba(255,255,255,.3);text-transform:uppercase;letter-spacing:1.5px;padding:10px 8px 4px;}
.di{display:flex;align-items:center;gap:10px;padding:11px 10px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:rgba(255,255,255,.65);margin-bottom:1px;transition:background .15s;}
.di:active{background:rgba(255,255,255,.15);}
.di.active{background:rgba(255,255,255,.15);color:#fff;font-weight:600;}
.di svg{width:16px;height:16px;flex-shrink:0;opacity:.75;}
.di.active svg{opacity:1;}
.dr-foot{margin:12px 10px 0;padding-top:12px;border-top:1px solid rgba(255,255,255,.1);}
.dr-out{display:flex;align-items:center;gap:9px;padding:11px 10px;border-radius:8px;background:rgba(255,255,255,.07);color:rgba(255,255,255,.6);font-size:13px;font-weight:600;cursor:pointer;}

/* PAGES */
.page{display:none;animation:fU .22s ease both;}
.page.active{display:block;}
@keyframes fU{from{opacity:0;transform:translateY(7px)}to{opacity:1;transform:none}}
.ph{margin-bottom:18px;display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:9px;}
.ph-l h2{font-family:'IBM Plex Serif',serif;font-size:20px;color:var(--g1);}
.ph-l p{font-size:11px;color:var(--txt3);margin-top:1px;}
.ph-r{display:flex;gap:7px;align-items:center;flex-wrap:wrap;}

/* STAT CARDS */
.sc-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:9px;margin-bottom:14px;}
.sc{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:13px 15px;border-top:3px solid var(--g2);}
.sc-lbl{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.sc-val{font-size:18px;font-weight:700;color:var(--txt);letter-spacing:-.3px;}
.sc-val.g{color:var(--g1);}.sc-val.r{color:var(--r1);}.sc-val.y{color:var(--y1);}.sc-val.gr{color:var(--g2);}
.sc-sub{font-size:9px;color:var(--txt3);margin-top:2px;}

/* ACCOUNT HERO */
.ah{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.ahc{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:15px 17px;border-left:4px solid var(--g2);}
.ahc-lbl{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px;}
.ahc-val{font-size:21px;font-weight:700;color:var(--g1);letter-spacing:-.4px;}
.ahc-sub{font-size:9px;color:var(--txt3);margin-top:2px;}

/* DASHBOARD BLOCKS */
.db-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;}
.db{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;}
.db-hd{background:var(--gp);padding:9px 13px;border-bottom:1px solid var(--bdr);display:flex;align-items:center;gap:5px;}
.db-hd h3{font-size:12px;font-weight:700;color:var(--g1);}
.db-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.db-row{display:flex;justify-content:space-between;align-items:center;padding:7px 13px;border-bottom:1px solid var(--gr);}
.db-row:last-child{border-bottom:none;}
.db-row .k{font-size:11px;color:var(--txt2);}
.db-row .v{font-size:12px;font-weight:700;color:var(--txt);}
.db-row .v.g{color:var(--g1);}.db-row .v.gr{color:var(--g2);}.db-row .v.r{color:var(--r1);}.db-row .v.y{color:var(--y1);}
.db-div{height:1px;background:var(--bdr);margin:3px 13px;}

/* FILTER BAR */
.fb{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:12px 15px;margin-bottom:11px;display:flex;gap:9px;align-items:flex-end;flex-wrap:wrap;}
.fb label{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.7px;display:block;margin-bottom:3px;}
.fb input,.fb select{background:var(--gp);border:1.5px solid var(--bdr);border-radius:7px;padding:7px 9px;color:var(--txt);font-size:12px;font-family:inherit;outline:none;}
.fb input:focus,.fb select:focus{border-color:var(--g2);}

/* SUMMARY BAR */
.smb{display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:7px;margin-bottom:11px;}
.smc{background:#fff;border:1px solid var(--bdr);border-radius:8px;padding:9px 12px;text-align:center;}
.smc-l{font-size:8px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.6px;margin-bottom:2px;}
.smc-v{font-size:14px;font-weight:700;color:var(--g1);}

/* column toggle now uses dropdown */

/* TABLES */
.tc{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;margin-bottom:13px;}
.tc-hd{padding:11px 15px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid var(--g2);flex-wrap:wrap;gap:7px;background:var(--gp);}
.tc-hd h3{font-size:12px;font-weight:700;color:var(--g1);}
.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:11.5px;}
thead th{background:var(--gr);padding:7px 11px;text-align:left;font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.6px;white-space:nowrap;border-bottom:1px solid var(--bdr);}
tbody td{padding:8px 11px;border-bottom:1px solid var(--gr);color:var(--txt);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover td{background:var(--gp);}
.badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:9px;font-weight:700;letter-spacing:.3px;}
.bo{background:var(--bp);color:var(--b1);}
.bc{background:var(--gr);color:var(--txt3);}
.bi{background:var(--gp);color:var(--g2);}
.bx{background:var(--rp);color:var(--r1);}
.nd{text-align:center;padding:34px;color:var(--txt3);font-size:12px;}

/* BUTTONS */
.btn{padding:7px 13px;border-radius:7px;font-size:11.5px;font-weight:600;cursor:pointer;font-family:inherit;border:none;transition:all .15s;display:inline-flex;align-items:center;gap:5px;white-space:nowrap;}
.btn:active{transform:scale(.97);}
.btn-g{background:var(--g1);color:#fff;}.btn-g:hover{background:var(--g2);}
.btn-gh{background:var(--gp);color:var(--g1);border:1px solid var(--bdr);}.btn-gh:hover{background:var(--gl);}
.btn-y{background:var(--y1);color:#fff;}
.btn-r{background:var(--rp);color:var(--r1);}.btn-r:hover{background:var(--r1);color:#fff;}
.btn-b{background:var(--bp);color:var(--b1);}.btn-b:hover{background:var(--b1);color:#fff;}
.btn-sm{padding:4px 8px;font-size:10px;border-radius:5px;}
.sinp{background:var(--gp);border:1.5px solid var(--bdr);border-radius:7px;padding:7px 10px;color:var(--txt);font-size:11.5px;font-family:inherit;outline:none;width:175px;}
.sinp:focus{border-color:var(--g2);}
.sinp::placeholder{color:var(--txt4);}
.dinp{background:var(--gp);border:1.5px solid var(--bdr);border-radius:7px;padding:7px 10px;color:var(--txt);font-size:11.5px;font-family:inherit;outline:none;}
.dinp:focus{border-color:var(--g2);}

/* MODAL */
.ov{display:none;position:fixed;inset:0;background:rgba(27,94,32,.3);z-index:3000;align-items:center;justify-content:center;padding:12px;backdrop-filter:blur(3px);}
.ov.open{display:flex;}
.modal{background:#fff;border:1px solid var(--bdr);border-radius:16px;padding:24px;width:560px;max-width:100%;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow2);}
.modal-lg{width:800px;}
.mt{font-family:'IBM Plex Serif',serif;font-size:17px;color:var(--g1);margin-bottom:18px;display:flex;align-items:center;gap:7px;}
.fg{display:flex;flex-direction:column;gap:4px;}
.fg label{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.7px;}
.fg input,.fg select{background:var(--gp);border:1.5px solid var(--bdr);border-radius:7px;padding:8px 10px;color:var(--txt);font-size:12.5px;font-family:inherit;outline:none;transition:border-color .2s;}
.fg input:focus,.fg select:focus{border-color:var(--g2);background:#fff;}
.fg input::placeholder{color:var(--txt4);}
.fg2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.fg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px;}
.fg1{display:grid;grid-template-columns:1fr;gap:10px;margin-bottom:10px;}
.mf{display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:13px;border-top:1px solid var(--bdr);}
.spb{background:var(--gr);border:1.5px solid var(--bdr);border-radius:9px;padding:12px;margin-top:7px;}
.sp-t{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.9px;margin-bottom:9px;}
.sp-row{display:grid;grid-template-columns:140px 1fr;align-items:center;gap:8px;margin-bottom:6px;}
.sp-lbl{font-size:11px;font-weight:600;color:var(--txt2);}
.sp-bar{display:flex;justify-content:space-between;align-items:center;padding-top:8px;border-top:1px solid var(--bdr);margin-top:7px;}
.sp-rem{font-size:10px;font-weight:700;color:var(--g2);}

/* BULK ENTRY */
.bs{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);margin-bottom:11px;overflow:hidden;}
.bsh{padding:10px 15px;background:var(--gp);border-bottom:1px solid var(--bdr);display:flex;align-items:center;justify-content:space-between;}
.bsh h4{font-size:12px;font-weight:700;color:var(--g1);display:flex;align-items:center;gap:6px;}
.bsb{padding:11px 15px;overflow-x:auto;}
.bhdr{display:grid;gap:6px;margin-bottom:4px;}
.bhdr span{font-size:8.5px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.6px;padding:0 2px;}
.bf{display:grid;gap:6px;align-items:end;margin-bottom:6px;}
.gf{grid-template-columns:82px 92px minmax(100px,1fr) 90px 65px 65px 60px 82px 82px 22px;}
.hf{grid-template-columns:82px 92px minmax(100px,1fr) 90px 60px 82px 82px 22px;}
/* Closed: Bill | LoanDate | LoanAmt | Interest | SG | EG | Status | del */
.clf{grid-template-columns:90px 90px 100px 100px 82px 82px 90px 22px;}
.clhdr{grid-template-columns:90px 90px 100px 100px 82px 82px 90px 22px;}
.eif{grid-template-columns:minmax(100px,1fr) 90px 82px 82px 82px 22px;}
.bi2{background:var(--gp);border:1.5px solid var(--bdr);border-radius:6px;padding:6px 7px;color:var(--txt);font-size:11px;font-family:inherit;outline:none;width:100%;transition:border-color .2s;}
.bi2:focus{border-color:var(--g2);background:#fff;}
.bi2::placeholder{color:var(--txt4);}
.bi2.ro{background:var(--gr);color:var(--txt2);cursor:default;}
.rmb{background:none;border:none;color:var(--txt4);cursor:pointer;font-size:17px;padding:0;line-height:1;align-self:center;transition:color .15s;}
.rmb:hover{color:var(--r1);}
.imp-bar{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:13px 17px;margin-bottom:13px;}
.imp-cols{display:grid;grid-template-columns:repeat(3,1fr);gap:9px;}
.imp-col{text-align:center;background:var(--gp);border-radius:7px;padding:10px;}
.imp-col .icn{font-size:9px;font-weight:600;color:var(--txt3);margin-bottom:2px;}
.imp-val{font-size:16px;font-weight:700;letter-spacing:-.3px;}
.pos{color:var(--g1);}.neg{color:var(--r1);}.neu{color:var(--txt3);}

/* LEDGER */
.lb{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:15px;margin-bottom:11px;}
.lb-t{font-size:9px;font-weight:700;color:var(--txt2);text-transform:uppercase;letter-spacing:.8px;margin-bottom:9px;}
.lb-g{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;}
.lbc{background:var(--gp);border-radius:7px;padding:9px;text-align:center;}
.lbc-l{font-size:9px;font-weight:600;color:var(--txt3);margin-bottom:2px;}
.lbc-v{font-size:16px;font-weight:700;color:var(--g1);}
.lbc-v.tot{color:var(--txt);}
.txl{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);overflow:hidden;margin-bottom:11px;}
.txi{display:grid;grid-template-columns:82px 60px 1fr 95px 85px 85px 85px;gap:7px;padding:9px 13px;border-bottom:1px solid var(--gr);align-items:center;font-size:11px;}
.txi:last-child{border-bottom:none;}
.txi:hover{background:var(--gp);}
.txi.txhdr{background:var(--gr);font-size:8.5px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.5px;}
.txdir{font-size:10px;font-weight:700;}
.txdir.in{color:var(--g2);}.txdir.out{color:var(--r1);}
.amc{font-size:11px;font-weight:600;}
.amc.pos{color:var(--g1);}.amc.neg{color:var(--r1);}.amc.neu{color:var(--txt4);}
.ls{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:15px;display:flex;gap:22px;flex-wrap:wrap;margin-bottom:11px;}
.ls-i label{font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;display:block;margin-bottom:2px;}
.ls-i span{font-size:14px;font-weight:700;}

/* SETTINGS */
.stg{background:#fff;border:1px solid var(--bdr);border-radius:var(--r);padding:20px;margin-bottom:11px;}
.stg h3{font-family:'IBM Plex Serif',serif;font-size:15px;color:var(--g1);margin-bottom:5px;}
.stg p{font-size:12px;color:var(--txt2);line-height:1.7;margin-bottom:13px;}
.sqlbox{background:var(--gr);border:1px solid var(--bdr);border-radius:8px;padding:11px;color:#1B5E20;font-family:monospace;font-size:10px;line-height:1.7;white-space:pre;overflow-x:auto;max-height:230px;overflow-y:auto;}
.imp-zone{border:2px dashed var(--bdr2);border-radius:10px;padding:30px;text-align:center;cursor:pointer;transition:all .2s;background:var(--gp);}
.imp-zone:hover,.imp-zone.drag{border-color:var(--g2);background:var(--gl);}
.bkp-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(190px,1fr));gap:11px;margin-top:6px;}
.bkp-card{background:var(--gp);border:1px solid var(--bdr);border-radius:9px;padding:16px;text-align:center;}
.bkp-card .ico{font-size:28px;margin-bottom:7px;}
.bkp-card .title{font-size:13px;font-weight:700;color:var(--g1);margin-bottom:3px;}
.bkp-card .sub{font-size:10px;color:var(--txt3);margin-bottom:11px;}
.steps{list-style:none;counter-reset:s;}
.steps li{counter-increment:s;display:flex;gap:9px;margin-bottom:9px;font-size:12px;color:var(--txt2);line-height:1.6;}
.steps li::before{content:counter(s);min-width:21px;height:21px;background:var(--gp);color:var(--g1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0;margin-top:1px;}

/* TOAST */
#toast{position:fixed;bottom:18px;right:18px;background:var(--g1);color:#fff;padding:10px 15px;border-radius:8px;font-size:12px;font-weight:500;opacity:0;transition:opacity .3s;z-index:9999;pointer-events:none;max-width:260px;box-shadow:var(--shadow2);}
#toast.show{opacity:1;}
#toast.err{background:var(--r1);}
#toast.ok{background:var(--g2);}

/* RESPONSIVE */
@media(max-width:900px){
  .sb{display:none;}.mob-hdr{display:flex;}.mob-nav{display:flex;}
  .mw{padding-top:52px;padding-bottom:66px;}
  .main{padding:13px 11px;}
  .ah,.db-grid{grid-template-columns:1fr;}
  .sc-grid{grid-template-columns:repeat(2,1fr);}
  .lb-g{grid-template-columns:1fr 1fr;}
  .txi{grid-template-columns:72px 1fr 75px;}
  .txi span:nth-child(n+5){display:none;}
  .fg2,.fg3{grid-template-columns:1fr;}
  .gf,.hf,.clf,.eif{grid-template-columns:1fr 1fr;}
  .imp-cols{grid-template-columns:1fr;}
  .fb{flex-direction:column;align-items:stretch;}
}
@media(max-width:480px){.sc-grid,.ah{grid-template-columns:1fr;}}

/* Column toggle checkbox dropdown */
.col-chk{display:flex;align-items:center;gap:8px;padding:5px 2px;font-size:12px;color:var(--txt);cursor:pointer;border-radius:5px;user-select:none;}
.col-chk:hover{background:var(--gp);}
.col-chk input[type=checkbox]{width:14px;height:14px;accent-color:var(--g1);cursor:pointer;flex-shrink:0;}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="lc">
    <div class="lc-icon">‚öú</div>
    <h1>Mani Finance</h1>
    <p>Management System</p>
    <label class="lbl">Username</label>
    <input class="inp" id="lu" placeholder="Enter username" onkeydown="if(event.key==='Enter')login()">
    <label class="lbl">Password</label>
    <input class="inp" type="password" id="lp" placeholder="Enter password" onkeydown="if(event.key==='Enter')login()">
    <button class="btn-login" onclick="login()">Sign In ‚Üí</button>
    <div class="lerr" id="lerr"></div>
  </div>
</div>

<!-- APP -->
<div id="app">
  <!-- Mobile Header -->
  <div class="mob-hdr">
    <button class="ham" onclick="openDrawer()"><span></span><span></span><span></span></button>
    <div class="mob-brand"><div class="mob-bi">‚öú</div>Mani Finance</div>
    <span style="font-size:10px;color:rgba(255,255,255,.55)" id="mobU"></span>
  </div>

  <!-- Side Drawer Overlay -->
  <div id="drawerOverlay" onclick="closeDrawer()"></div>

  <!-- Side Drawer -->
  <div id="sideDrawer">
    <div class="dr-hdr">
      <div style="display:flex;align-items:center;gap:9px">
        <div style="width:32px;height:32px;background:var(--y2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:14px">‚öú</div>
        <div><div style="font-size:14px;font-weight:700;color:#fff">Mani Finance</div><div id="drUser" style="font-size:10px;color:rgba(255,255,255,.5)">Admin</div></div>
      </div>
      <button class="dr-close" onclick="closeDrawer()">‚úï</button>
    </div>
    <div class="dr-body">
      <div class="dr-sec">Main</div>
      <div class="di active" id="di-db" onclick="goDr('db')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</div>
      <div class="di" id="di-bulk" onclick="goDr('bulk')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>End of Day Entry</div>
      <div class="dr-sec">Records</div>
      <div class="di" id="di-gold" onclick="goDr('gold')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>Gold Loans</div>
      <div class="di" id="di-hand" onclick="goDr('hand')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Hand Loans</div>
      <div class="di" id="di-inv" onclick="goDr('inv')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>Investments</div>
      <div class="di" id="di-exp" onclick="goDr('exp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Expenses</div>
      <div class="dr-sec">Finance</div>
      <div class="di" id="di-led" onclick="goDr('led')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Daily Ledger</div>
      <div class="di" id="di-acc" onclick="goDr('acc')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>Accounts</div>
      <div class="dr-sec">Data</div>
      <div class="di" id="di-imp" onclick="goDr('imp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import Data</div>
      <div class="di" id="di-bkp" onclick="goDr('bkp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Backup & Export</div>
      <div class="di" id="di-set" onclick="goDr('set')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings</div>
      <div class="dr-foot"><div class="dr-out" onclick="logout()"><svg width="15" height="15" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>Sign Out</div></div>
    </div>
  </div>

  <div class="aw">
    <!-- Sidebar Desktop -->
    <div class="sb">
      <div class="sb-top">
        <div class="sb-brand"><div class="sb-bi">‚öú</div><div class="sb-bt"><h2>MFinance</h2><p>Finance Mgr</p></div></div>
      </div>
      <div class="sb-usr"><div class="sb-av" id="sbAv">A</div><div><div class="sb-un" id="sbNm">Admin</div><div class="sb-ur" id="sbRl">Owner</div></div></div>
      <div class="sb-nav">
        <div class="ng">Main</div>
        <div class="ni active" id="ni-db" onclick="go('db')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Dashboard</div>
        <div class="ni" id="ni-bulk" onclick="go('bulk')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>End of Day Entry</div>
        <div class="ng">Records</div>
        <div class="ni" id="ni-gold" onclick="go('gold')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>Gold Loans</div>
        <div class="ni" id="ni-hand" onclick="go('hand')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Hand Loans</div>
        <div class="ni" id="ni-inv" onclick="go('inv')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>Investments</div>
        <div class="ni" id="ni-exp" onclick="go('exp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>Expenses</div>
        <div class="ng">Finance</div>
        <div class="ni" id="ni-led" onclick="go('led')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Daily Ledger</div>
        <div class="ni" id="ni-acc" onclick="go('acc')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2"/><line x1="2" y1="10" x2="22" y2="10"/></svg>Accounts</div>
        <div class="ng">Data</div>
        <div class="ni" id="ni-imp" onclick="go('imp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Import Data</div>
        <div class="ni" id="ni-bkp" onclick="go('bkp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Backup & Export</div>
        <div class="ni" id="ni-set" onclick="go('set')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings</div>
      </div>
      <div class="sb-bot"><button class="btn-out" onclick="logout()">Sign Out</button></div>
    </div>

    <!-- Main Content -->
    <div class="mw"><div class="main">

      <!-- DASHBOARD -->
      <div class="page active" id="pg-db">
        <div class="ph"><div class="ph-l"><h2>Dashboard</h2><p id="dbDate"></p></div><div class="ph-r"><button class="btn btn-gh" onclick="go('bulk')">+ Day Entry</button><button class="btn btn-g" onclick="go('bkp')">‚¨á Backup</button></div></div>
        <div class="ah" id="ahero"></div>
        <div class="sc-grid" id="scards"></div>
        <div class="db-grid" id="dblocks"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
          <div class="tc"><div class="tc-hd"><h3>Recent Gold Loans</h3></div><table><thead><tr><th>Bill</th><th>Customer</th><th>Amount</th><th>Status</th></tr></thead><tbody id="dgold"></tbody></table></div>
          <div class="tc"><div class="tc-hd"><h3>Recent Hand Loans</h3></div><table><thead><tr><th>Bill</th><th>Customer</th><th>Amount</th><th>Status</th></tr></thead><tbody id="dhand"></tbody></table></div>
        </div>
      </div>

      <!-- BULK ENTRY -->
      <div class="page" id="pg-bulk">
        <div class="ph"><div class="ph-l"><h2>End of Day Entry</h2><p>Enter all transactions for the day</p></div>
          <div class="ph-r"><div style="display:flex;flex-direction:column;gap:2px"><label style="font-size:9px;color:var(--txt3)">Entry Date</label><input type="date" id="bulkDate" class="dinp"></div></div></div>

        <!-- Gold Given -->
        <div class="bs"><div class="bsh"><h4>ü•á New Gold Loans Given</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('g')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr gf"><span>Bill No</span><span>Date</span><span>Customer | Phone | Address | Items</span><span>Loan ‚Çπ</span><span>Gr.Wt</span><span>Nt.Wt</span><span>Rate%</span><span>SG Phone</span><span>EG Phone</span><span></span></div>
            <div id="bGold"></div></div></div>

        <!-- Hand Given -->
        <div class="bs"><div class="bsh"><h4>ü§ù New Hand Loans Given</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('h')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr hf"><span>Bill No</span><span>Date</span><span>Customer | Phone</span><span>Loan ‚Çπ</span><span>Rate%</span><span>SG Phone</span><span>EG Phone</span><span></span></div>
            <div id="bHand"></div></div></div>

        <!-- Gold Closed -->
        <div class="bs"><div class="bsh"><h4>‚úÖ Gold Loans ‚Äî Payment Received Today</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('gc')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr clhdr"><span>Bill No</span><span>Loan Date</span><span>Loan Amt ‚Çπ</span><span>Interest Recd ‚Çπ</span><span>SG Phone ‚Çπ</span><span>EG Phone ‚Çπ</span><span>Status</span><span></span></div>
            <div id="bGC"></div></div></div>

        <!-- Hand Closed -->
        <div class="bs"><div class="bsh"><h4>‚úÖ Hand Loans ‚Äî Payment Received Today</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('hc')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr clhdr"><span>Bill No</span><span>Loan Date</span><span>Loan Amt ‚Çπ</span><span>Interest Recd ‚Çπ</span><span>SG Phone ‚Çπ</span><span>EG Phone ‚Çπ</span><span>Status</span><span></span></div>
            <div id="bHC"></div></div></div>

        <!-- Expenses -->
        <div class="bs"><div class="bsh"><h4>üßæ Expenses Paid Today</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('e')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr eif"><span>Expense Name</span><span>Amount ‚Çπ</span><span>Cash ‚Çπ</span><span>SG Phone ‚Çπ</span><span>EG Phone ‚Çπ</span><span></span></div>
            <div id="bExp"></div></div></div>

        <!-- Investments -->
        <div class="bs"><div class="bsh"><h4>üìà Investments Received Today</h4><button class="btn btn-gh" style="font-size:10px;padding:4px 9px" onclick="addBR('i')">+ Add Row</button></div>
          <div class="bsb">
            <div class="bhdr eif"><span>Partner Name</span><span>Amount ‚Çπ</span><span>Cash ‚Çπ</span><span>SG Phone ‚Çπ</span><span>EG Phone ‚Çπ</span><span></span></div>
            <div id="bInv"></div></div></div>

        <div class="imp-bar"><h4 style="font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.9px;margin-bottom:9px">Today's Net Impact <span style="color:var(--txt4);font-size:8px">(SG/EG blank = auto cash)</span></h4>
          <div class="imp-cols">
            <div class="imp-col"><div class="icn">üíµ Cash Change</div><div class="imp-val neu" id="impC">‚Çπ0</div></div>
            <div class="imp-col"><div class="icn">üè¶ SG Phone</div><div class="imp-val neu" id="impS">‚Çπ0</div></div>
            <div class="imp-col"><div class="icn">üè¶ EG Phone</div><div class="imp-val neu" id="impE">‚Çπ0</div></div>
          </div></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button class="btn btn-gh" onclick="clearBulk()">Clear All</button>
          <button class="btn btn-g" onclick="saveBulk()">üíæ Save All Transactions</button>
        </div>
      </div>

      <!-- GOLD LOANS -->
      <div class="page" id="pg-gold">
        <div class="ph"><div class="ph-l"><h2>Gold Loans</h2><p>All pledge bill transactions</p></div>
          <div class="ph-r"><button class="btn btn-g" onclick="openGM()">+ New Bill</button></div></div>
        <!-- Filters -->
        <div class="fb">
          <div><label>Search</label><input class="sinp" id="gSearch" placeholder="Bill No / Customer / Phone" oninput="applyGoldFilter()"></div>
          <div><label>From Date</label><input type="date" id="gFrom" class="dinp" onchange="applyGoldFilter()"></div>
          <div><label>To Date</label><input type="date" id="gTo" class="dinp" onchange="applyGoldFilter()"></div>
          <div><label>Status</label><select id="gStat2" class="dinp" onchange="applyGoldFilter()"><option value="">All</option><option>Open</option><option>Closed</option></select></div>
          <button class="btn btn-gh" onclick="clearGoldFilter()">Clear</button>
        </div>
        <!-- Summary -->
        <div class="smb" id="goldSummary"></div>
        <!-- Column Toggle Dropdown -->
        <div style="position:relative;display:inline-block;margin-bottom:9px">
          <button class="btn btn-gh" onclick="toggleColMenu('gColMenu')" style="display:flex;align-items:center;gap:6px">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 20h9M4.5 6h15M4.5 12h15"/></svg>
            Columns ‚ñæ
          </button>
          <div id="gColMenu" style="display:none;position:absolute;top:110%;left:0;background:#fff;border:1.5px solid var(--bdr);border-radius:10px;padding:10px 14px;z-index:500;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:170px">
            <div style="font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Show / Hide Columns</div>
            <label class="col-chk"><input type="checkbox" id="gc_gw" checked onchange="togGCol('gw')"> Gross Weight</label>
            <label class="col-chk"><input type="checkbox" id="gc_nw" checked onchange="togGCol('nw')"> Net Weight</label>
            <label class="col-chk"><input type="checkbox" id="gc_rate" checked onchange="togGCol('rate')"> Interest Rate %</label>
            <label class="col-chk"><input type="checkbox" id="gc_interest" checked onchange="togGCol('interest')"> Interest Amount</label>
            <label class="col-chk"><input type="checkbox" id="gc_phone" checked onchange="togGCol('phone')"> Phone</label>
            <label class="col-chk"><input type="checkbox" id="gc_addr" checked onchange="togGCol('addr')"> Address</label>
            <label class="col-chk"><input type="checkbox" id="gc_cash" onchange="togGCol('cash')"> Cash Given</label>
            <label class="col-chk"><input type="checkbox" id="gc_sg" onchange="togGCol('sg')"> SG Phone</label>
            <label class="col-chk"><input type="checkbox" id="gc_eg" onchange="togGCol('eg')"> EG Phone</label>
          </div>
        </div>
        <div class="tc"><div class="tw"><table id="goldTable"><thead id="goldHead"></thead><tbody id="goldTbl"></tbody></table></div></div>
      </div>

      <!-- HAND LOANS -->
      <div class="page" id="pg-hand">
        <div class="ph"><div class="ph-l"><h2>Hand Loans</h2><p>All outside / hand loans</p></div>
          <div class="ph-r"><button class="btn btn-g" onclick="openHM()">+ New Loan</button></div></div>
        <div class="fb">
          <div><label>Search</label><input class="sinp" id="hSearch" placeholder="Bill No / Customer / Phone" oninput="applyHandFilter()"></div>
          <div><label>From Date</label><input type="date" id="hFrom" class="dinp" onchange="applyHandFilter()"></div>
          <div><label>To Date</label><input type="date" id="hTo" class="dinp" onchange="applyHandFilter()"></div>
          <div><label>Status</label><select id="hStat2" class="dinp" onchange="applyHandFilter()"><option value="">All</option><option>Open</option><option>Closed</option></select></div>
          <button class="btn btn-gh" onclick="clearHandFilter()">Clear</button>
        </div>
        <div class="smb" id="handSummary"></div>
        <!-- Column Toggle Dropdown -->
        <div style="position:relative;display:inline-block;margin-bottom:9px">
          <button class="btn btn-gh" onclick="toggleColMenu('hColMenu')" style="display:flex;align-items:center;gap:6px">
            <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 20h9M4.5 6h15M4.5 12h15"/></svg>
            Columns ‚ñæ
          </button>
          <div id="hColMenu" style="display:none;position:absolute;top:110%;left:0;background:#fff;border:1.5px solid var(--bdr);border-radius:10px;padding:10px 14px;z-index:500;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:170px">
            <div style="font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Show / Hide Columns</div>
            <label class="col-chk"><input type="checkbox" id="hc_rate" checked onchange="togHCol('rate')"> Interest Rate %</label>
            <label class="col-chk"><input type="checkbox" id="hc_interest" checked onchange="togHCol('interest')"> Interest Amount</label>
            <label class="col-chk"><input type="checkbox" id="hc_phone" checked onchange="togHCol('phone')"> Phone</label>
            <label class="col-chk"><input type="checkbox" id="hc_repay" checked onchange="togHCol('repay')"> Repay Date</label>
            <label class="col-chk"><input type="checkbox" id="hc_cash" onchange="togHCol('cash')"> Cash Given</label>
            <label class="col-chk"><input type="checkbox" id="hc_sg" onchange="togHCol('sg')"> SG Phone</label>
            <label class="col-chk"><input type="checkbox" id="hc_eg" onchange="togHCol('eg')"> EG Phone</label>
          </div>
        </div>
        <div class="tc"><div class="tw"><table id="handTable"><thead id="handHead"></thead><tbody id="handTbl"></tbody></table></div></div>
      </div>

      <!-- INVESTMENTS -->
      <div class="page" id="pg-inv">
        <div class="ph"><div class="ph-l"><h2>Investments</h2></div><div class="ph-r"><button class="btn btn-g" onclick="openIM()">+ Add Investment</button></div></div>
        <div class="tc"><div class="tw"><table><thead><tr><th>#</th><th>Date</th><th>Partner</th><th>Amount ‚Çπ</th><th>Cash ‚Çπ</th><th>SG Phone ‚Çπ</th><th>EG Phone ‚Çπ</th><th>Status</th><th>Comments</th><th>Actions</th></tr></thead><tbody id="invTbl"></tbody></table></div></div>
      </div>

      <!-- EXPENSES -->
      <div class="page" id="pg-exp">
        <div class="ph"><div class="ph-l"><h2>Expenses</h2></div><div class="ph-r"><button class="btn btn-g" onclick="openEM()">+ Add Expense</button></div></div>
        <div class="tc"><div class="tw"><table><thead><tr><th>#</th><th>Date</th><th>Name</th><th>Amount ‚Çπ</th><th>Cash ‚Çπ</th><th>SG Phone ‚Çπ</th><th>EG Phone ‚Çπ</th><th>Comments</th><th>Actions</th></tr></thead><tbody id="expTbl"></tbody></table></div></div>
      </div>

      <!-- LEDGER -->
      <div class="page" id="pg-led">
        <div class="ph"><div class="ph-l"><h2>Daily Ledger</h2></div>
          <div class="ph-r" style="gap:6px">
            <label style="font-size:10px;color:var(--txt3)">From</label><input type="date" id="lf" class="dinp">
            <label style="font-size:10px;color:var(--txt3)">To</label><input type="date" id="lt" class="dinp">
            <button class="btn btn-g" onclick="renderLed()">View</button>
            <button class="btn btn-gh" onclick="exportLedger()">‚¨á Export</button>
          </div></div>
        <div id="ledOut"></div>
      </div>

      <!-- ACCOUNTS -->
      <div class="page" id="pg-acc">
        <div class="ph">
          <div class="ph-l"><h2>Account Summary</h2><p>Track balances and transfer funds between accounts</p></div>
          <div class="ph-r" style="gap:6px">
            <label style="font-size:10px;color:var(--txt3)">From</label><input type="date" id="af" class="dinp">
            <label style="font-size:10px;color:var(--txt3)">To</label><input type="date" id="at" class="dinp">
            <button class="btn btn-gh" onclick="renderAcc()">View</button>
            <button class="btn btn-g" onclick="openTM()">‚áÑ Transfer Funds</button>
          </div>
        </div>
        <div class="ah" id="accCards"></div>
        <!-- Transfer history mini-table -->
        <div id="accTransfers" style="margin-bottom:11px"></div>
        <div class="tc"><div class="tw"><table><thead><tr><th>Date</th><th>Type</th><th>Description</th><th>Total</th><th>Cash ‚Çπ</th><th>SG Phone ‚Çπ</th><th>EG Phone ‚Çπ</th><th>Dir</th></tr></thead><tbody id="accTbl"></tbody></table></div></div>
      </div>

      <!-- IMPORT -->
      <div class="page" id="pg-imp">
        <div class="ph"><div class="ph-l"><h2>Import Data</h2><p>Upload Excel template to load all data</p></div></div>
        <div class="stg">
          <h3>üì• Upload Excel Template</h3>
          <p>Fill the compatible import template and upload here. All rows import instantly.</p>
          <div class="imp-zone" id="dropZone" onclick="document.getElementById('fileInp').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="handleDrop(event)">
            <div style="font-size:36px;margin-bottom:9px">üìÇ</div>
            <h3 style="font-size:13px;font-weight:600;color:var(--g1);margin-bottom:5px">Click to browse or drag & drop</h3>
            <p style="font-size:11px;color:var(--txt3)">.xlsx files only ¬∑ Mani Finance Import Template format</p>
          </div>
          <input type="file" id="fileInp" accept=".xlsx" style="display:none" onchange="handleFile(this.files[0])">
          <div id="impResult" style="display:none;margin-top:12px;background:var(--gp);border:1px solid var(--bdr);border-radius:8px;padding:13px;"></div>
        </div>
        <div class="stg">
          <h3>üìã Import Rules</h3>
          <ul style="font-size:12px;color:var(--txt2);line-height:2.1;padding-left:18px">
            <li>Dates must be in <strong>DD-MM-YYYY</strong> format</li>
            <li>Status: exactly <strong>Open</strong> or <strong>Closed</strong></li>
            <li>Amount columns: plain numbers only ‚Äî no ‚Çπ or commas</li>
            <li>Leave Cash column blank ‚Äî auto-calculated from SG + EG</li>
          </ul>
        </div>
      </div>

      <!-- BACKUP -->
      <div class="page" id="pg-bkp">
        <div class="ph"><div class="ph-l"><h2>Backup & Export</h2></div></div>
        <div class="stg">
          <h3>üì¶ Download Backup</h3>
          <p>One combined Excel file with all 4 data sheets.</p>
          <div class="bkp-grid">
            <div class="bkp-card"><div class="ico">üìä</div><div class="title">Complete Backup</div><div class="sub" id="totalCount">All sections</div><button class="btn btn-g" style="width:100%" onclick="exportAll()">‚¨á Download All Data</button></div>
            <div class="bkp-card"><div class="ico">ü•á</div><div class="title">Gold Loans Only</div><div class="sub" id="goldCnt">‚Äî</div><button class="btn btn-gh" style="width:100%" onclick="exportSheet('gold')">‚¨á Export</button></div>
            <div class="bkp-card"><div class="ico">ü§ù</div><div class="title">Hand Loans Only</div><div class="sub" id="handCnt">‚Äî</div><button class="btn btn-gh" style="width:100%" onclick="exportSheet('hand')">‚¨á Export</button></div>
            <div class="bkp-card"><div class="ico">üìà</div><div class="title">Investments Only</div><div class="sub" id="invCnt">‚Äî</div><button class="btn btn-gh" style="width:100%" onclick="exportSheet('inv')">‚¨á Export</button></div>
            <div class="bkp-card"><div class="ico">üßæ</div><div class="title">Expenses Only</div><div class="sub" id="expCnt">‚Äî</div><button class="btn btn-gh" style="width:100%" onclick="exportSheet('exp')">‚¨á Export</button></div>
          </div>
        </div>
        <div class="stg">
          <h3>üí° Backup Tips</h3>
          <ul style="font-size:12px;color:var(--txt2);line-height:2.1;padding-left:18px">
            <li>Download a full backup <strong>every week</strong></li>
            <li>Save to <strong>Google Drive or WhatsApp</strong> for safety</li>
            <li>Exported file is compatible with Import ‚Äî re-import if needed</li>
          </ul>
        </div>
      </div>

      <!-- SETTINGS -->
      <div class="page" id="pg-set">
        <div class="ph"><div class="ph-l"><h2>Settings</h2></div></div>
        <div class="stg">
          <h3>üîó Supabase Connection</h3>
          <ol class="steps">
            <li>Go to <strong>supabase.com</strong> ‚Üí New Project</li>
            <li>SQL Editor ‚Üí paste SQL below ‚Üí Run</li>
            <li>Project Settings ‚Üí API Keys ‚Üí copy URL & Publishable key</li>
            <li>Paste below ‚Üí Save & Test</li>
          </ol>
          <div class="fg2" style="margin-top:12px">
            <div class="fg"><label>Supabase Project URL</label><input type="text" id="cfgUrl" placeholder="https://xxxx.supabase.co"></div>
            <div class="fg"><label>Supabase Anon / Publishable Key</label><input type="password" id="cfgKey" placeholder="sb_publishable_..."></div>
          </div>
          <div style="display:flex;gap:9px;align-items:center;flex-wrap:wrap">
            <button class="btn btn-g" onclick="saveConfig()">Save & Test Connection</button>
            <span id="cfgSt" style="font-size:11px;color:var(--txt3)"></span>
          </div>
        </div>
        <div class="stg">
          <h3>üí∞ Opening Balances</h3>
          <div class="fg3">
            <div class="fg"><label>üíµ Cash Opening ‚Çπ</label><input type="number" id="obC" placeholder="0"></div>
            <div class="fg"><label>üè¶ SG Phone Pay ‚Çπ</label><input type="number" id="obS" placeholder="0"></div>
            <div class="fg"><label>üè¶ EG Phone Pay ‚Çπ</label><input type="number" id="obE" placeholder="0"></div>
          </div>
          <div class="fg" style="margin-top:10px;max-width:200px"><label>Opening Balance Date</label><input type="date" id="obD" style="background:var(--gp);border:1.5px solid var(--bdr);border-radius:7px;padding:8px 10px;color:var(--txt);font-size:12.5px;font-family:inherit;outline:none;width:100%;"></div>
          <button class="btn btn-g" style="margin-top:12px" onclick="saveOB()">Save Opening Balances</button>
        </div>
        <div class="stg">
          <h3>üîë Change Passwords</h3>
          <div class="fg2">
            <div class="fg"><label>Admin New Password</label><input type="password" id="pw1" placeholder="Leave blank to keep"></div>
            <div class="fg"><label>User2 New Password</label><input type="password" id="pw2" placeholder="Leave blank to keep"></div>
          </div>
          <button class="btn btn-g" style="margin-top:8px" onclick="savePW()">Update Passwords</button>
        </div>
        <div class="stg">
          <h3>üìã SQL Setup Script</h3>
          <div class="sqlbox" id="sqlBox"></div>
          <button class="btn btn-gh" style="margin-top:9px" onclick="copySql()">üìã Copy SQL</button>
        </div>
      </div>

    </div></div>
  </div>

  <!-- Mobile Bottom Nav -->
  <div class="mob-nav">
    <div class="mi active" id="mn-db" onclick="go('db')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>Home</div>
    <div class="mi" id="mn-bulk" onclick="go('bulk')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Day Entry</div>
    <div class="mi" id="mn-gold" onclick="go('gold')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5z"/></svg>Gold</div>
    <div class="mi" id="mn-led" onclick="go('led')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Ledger</div>
    <div class="mi" id="mn-bkp" onclick="go('bkp')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Backup</div>
  </div>
</div>

<!-- MODALS -->
<!-- Gold Modal -->
<div class="ov" id="gModal"><div class="modal modal-lg">
  <div class="mt">ü•á <span id="gMT">New Gold Loan Bill</span></div><input type="hidden" id="gId">
  <div class="fg3"><div class="fg"><label>Bill No</label><input type="text" id="gBill" placeholder="A-01"></div><div class="fg"><label>Date</label><input type="date" id="gDate"></div><div class="fg"><label>Status</label><select id="gStat" onchange="tGC()"><option>Open</option><option>Closed</option></select></div></div>
  <div class="fg2"><div class="fg"><label>Customer Name</label><input type="text" id="gCust" placeholder="Full name"></div><div class="fg"><label>Phone</label><input type="text" id="gPhone"></div></div>
  <div class="fg1"><div class="fg"><label>Address</label><input type="text" id="gAddr" placeholder="Customer address"></div></div>
  <div class="fg3"><div class="fg"><label>Items</label><input type="text" id="gItems" placeholder="Ring, Chain‚Ä¶"></div><div class="fg"><label>Gross Weight (g)</label><input type="number" id="gGW" placeholder="0"></div><div class="fg"><label>Net Weight (g)</label><input type="number" id="gNW" placeholder="0"></div></div>
  <div class="fg2"><div class="fg"><label>Loan Amount ‚Çπ</label><input type="number" id="gLoan" placeholder="0" oninput="updS('g')"></div><div class="fg"><label>Interest Rate (%/month)</label><input type="number" id="gRate" placeholder="1.5" step="0.1"></div></div>
  <div class="spb"><div class="sp-t">üí∞ Loan Given ‚Äî Payment Split</div>
    <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="gCash" placeholder="Auto-calculated" oninput="updS('g')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="gSG" placeholder="0" oninput="updS('g')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="gEG" placeholder="0" oninput="updS('g')"></div>
    <div class="sp-bar"><span style="font-size:9px;color:var(--txt3)">Leave Cash blank ‚Üí auto-calculated</span><span class="sp-rem" id="gRem">Cash auto: ‚Çπ0</span></div></div>
  <div id="gCD" style="display:none;margin-top:10px">
    <div class="fg3"><div class="fg"><label>Release Date</label><input type="date" id="gRD"></div><div class="fg"><label>Interest Received ‚Çπ</label><input type="number" id="gIR" placeholder="0" oninput="updCS('g')"></div><div></div></div>
    <div class="spb"><div class="sp-t">üí∞ Amount Received Back ‚Äî Split</div>
      <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="gRC" placeholder="Auto-calculated" oninput="updCS('g')"></div>
      <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="gRS" placeholder="0" oninput="updCS('g')"></div>
      <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="gRE" placeholder="0" oninput="updCS('g')"></div>
      <div class="sp-bar"><span style="font-size:9px;color:var(--txt3)">Leave Cash blank ‚Üí auto-calculated</span><span class="sp-rem" id="gRRem">Cash auto: ‚Çπ0</span></div></div>
  </div>
  <div class="mf"><button class="btn btn-gh" onclick="closeM('gModal')">Cancel</button><button class="btn btn-g" onclick="saveGold()">Save Bill</button></div>
</div></div>

<!-- Hand Modal -->
<div class="ov" id="hModal"><div class="modal">
  <div class="mt">ü§ù <span id="hMT">New Hand Loan</span></div><input type="hidden" id="hId">
  <div class="fg2"><div class="fg"><label>Bill No</label><input type="text" id="hBill" placeholder="H-01"></div><div class="fg"><label>Date</label><input type="date" id="hDate"></div></div>
  <div class="fg2"><div class="fg"><label>Customer Name</label><input type="text" id="hCust"></div><div class="fg"><label>Phone</label><input type="text" id="hPhone"></div></div>
  <div class="fg2"><div class="fg"><label>Loan Amount ‚Çπ</label><input type="number" id="hLoan" placeholder="0" oninput="updS('h')"></div><div class="fg"><label>Interest Rate (%/month)</label><input type="number" id="hRate" placeholder="1.5" step="0.1"></div></div>
  <div class="fg2"><div class="fg"><label>Status</label><select id="hStat" onchange="tHC()"><option>Open</option><option>Closed</option></select></div><div class="fg"><label>Expected Repay Date</label><input type="date" id="hRD2"></div></div>
  <div class="spb"><div class="sp-t">üí∞ Loan Given ‚Äî Payment Split</div>
    <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="hCash" placeholder="Auto-calculated" oninput="updS('h')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="hSG" placeholder="0" oninput="updS('h')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="hEG" placeholder="0" oninput="updS('h')"></div>
    <div class="sp-bar"><span style="font-size:9px;color:var(--txt3)">Leave Cash blank ‚Üí auto-calculated</span><span class="sp-rem" id="hRem">Cash auto: ‚Çπ0</span></div></div>
  <div id="hCD" style="display:none;margin-top:10px">
    <div class="fg2"><div class="fg"><label>Repay Date (Actual)</label><input type="date" id="hRelD"></div><div class="fg"><label>Interest Received ‚Çπ</label><input type="number" id="hIR" placeholder="0" oninput="updCS('h')"></div></div>
    <div class="spb"><div class="sp-t">üí∞ Amount Received Back ‚Äî Split</div>
      <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="hRC" placeholder="Auto-calculated" oninput="updCS('h')"></div>
      <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="hRS" placeholder="0" oninput="updCS('h')"></div>
      <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="hRE" placeholder="0" oninput="updCS('h')"></div>
      <div class="sp-bar"><span style="font-size:9px;color:var(--txt3)">Leave Cash blank ‚Üí auto-calculated</span><span class="sp-rem" id="hRRem">Cash auto: ‚Çπ0</span></div></div>
  </div>
  <div class="mf"><button class="btn btn-gh" onclick="closeM('hModal')">Cancel</button><button class="btn btn-g" onclick="saveHand()">Save Loan</button></div>
</div></div>

<!-- Inv Modal -->
<div class="ov" id="iModal"><div class="modal">
  <div class="mt">üìà Investment</div><input type="hidden" id="iId">
  <div class="fg2"><div class="fg"><label>Date</label><input type="date" id="iDate"></div><div class="fg"><label>Partner Name</label><input type="text" id="iPart" placeholder="Partner1"></div></div>
  <div class="fg2"><div class="fg"><label>Amount ‚Çπ</label><input type="number" id="iAmt" placeholder="0" oninput="updS('i')"></div><div class="fg"><label>Status</label><select id="iStat"><option>Open</option><option>Closed</option></select></div></div>
  <div class="fg1"><div class="fg"><label>Comments</label><input type="text" id="iCmt" placeholder="Optional"></div></div>
  <div class="spb"><div class="sp-t">üí∞ Received Via</div>
    <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="iCash" placeholder="Auto-calculated" oninput="updS('i')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="iSG" placeholder="0" oninput="updS('i')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="iEG" placeholder="0" oninput="updS('i')"></div>
    <div class="sp-bar"><span></span><span class="sp-rem" id="iRem">Cash auto: ‚Çπ0</span></div></div>
  <div class="mf"><button class="btn btn-gh" onclick="closeM('iModal')">Cancel</button><button class="btn btn-g" onclick="saveInv()">Save</button></div>
</div></div>

<!-- Exp Modal -->
<div class="ov" id="eModal"><div class="modal">
  <div class="mt">üßæ Expense</div><input type="hidden" id="eId">
  <div class="fg2"><div class="fg"><label>Date</label><input type="date" id="eDate"></div><div class="fg"><label>Expense Name</label><input type="text" id="eName" placeholder="Office Rent"></div></div>
  <div class="fg2"><div class="fg"><label>Amount ‚Çπ</label><input type="number" id="eAmt" placeholder="0" oninput="updS('e')"></div><div class="fg"><label>Comments</label><input type="text" id="eCmt" placeholder="Optional"></div></div>
  <div class="spb"><div class="sp-t">üí∞ Paid Via</div>
    <div class="sp-row"><span class="sp-lbl">üíµ Cash</span><input class="bi2" type="number" id="eCash" placeholder="Auto-calculated" oninput="updS('e')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ SG Phone Pay</span><input class="bi2" type="number" id="eSG" placeholder="0" oninput="updS('e')"></div>
    <div class="sp-row"><span class="sp-lbl">üè¶ EG Phone Pay</span><input class="bi2" type="number" id="eEG" placeholder="0" oninput="updS('e')"></div>
    <div class="sp-bar"><span></span><span class="sp-rem" id="eRem">Cash auto: ‚Çπ0</span></div></div>
  <div class="mf"><button class="btn btn-gh" onclick="closeM('eModal')">Cancel</button><button class="btn btn-g" onclick="saveExp()">Save</button></div>
</div></div>

<!-- Transfer Modal -->
<div class="ov" id="tModal"><div class="modal">
  <div class="mt">‚áÑ Fund Transfer Between Accounts</div>
  <input type="hidden" id="tId">
  <div class="fg2">
    <div class="fg"><label>Date</label><input type="date" id="tDate"></div>
    <div class="fg"><label>Amount ‚Çπ</label><input type="number" id="tAmt" placeholder="0" oninput="previewTransfer()"></div>
  </div>
  <div class="fg2">
    <div class="fg">
      <label>From Account</label>
      <select id="tFrom" onchange="previewTransfer()">
        <option value="sg">üè¶ SG Phone Pay</option>
        <option value="eg">üè¶ EG Phone Pay</option>
        <option value="cash">üíµ Cash</option>
      </select>
    </div>
    <div class="fg">
      <label>To Account</label>
      <select id="tTo" onchange="previewTransfer()">
        <option value="cash">üíµ Cash</option>
        <option value="sg">üè¶ SG Phone Pay</option>
        <option value="eg">üè¶ EG Phone Pay</option>
      </select>
    </div>
  </div>
  <div class="fg1"><div class="fg"><label>Remarks</label><input type="text" id="tRem" placeholder="e.g. Withdrew from SG Phone to cash"></div></div>
  <div id="tPreview" style="display:none;background:var(--gp);border:1.5px solid var(--bdr);border-radius:9px;padding:13px;margin-top:6px">
    <div style="font-size:9px;font-weight:700;color:var(--txt3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:9px">Transfer Preview</div>
    <div id="tPreviewBody" style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;text-align:center">
    </div>
  </div>
  <div class="mf"><button class="btn btn-gh" onclick="closeM('tModal')">Cancel</button><button class="btn btn-g" onclick="saveTransfer()">Save Transfer</button></div>
</div></div>

<div id="toast"></div>

<script>
// ‚ïê‚ïê CORE ‚ïê‚ïê
let CFG=JSON.parse(localStorage.getItem('fs_cfg')||'{"url":"","key":"","pw1":"admin123","pw2":"user456","obC":0,"obS":0,"obE":0,"obD":""}');
let CU=null;
let gCols={gw:true,nw:true,rate:true,interest:true,cash:false,sg:false,eg:false,addr:true,phone:true};
let hCols={rate:true,interest:true,cash:false,sg:false,eg:false,phone:true,repay:true};
const $=(e,p)=>p?p.querySelector(e):document.getElementById(e);
const v=e=>$(e)?$(e).value:'';
const n=e=>parseFloat(v(e))||0;
// ‚îÄ‚îÄ STORAGE ‚Äî localStorage + Supabase sync ‚îÄ‚îÄ
const TABLES={gold:'gold_loans',hand:'hand_loans',inv:'investments',exp:'expenses',xfer:'fund_transfers'};
const gl=k=>JSON.parse(localStorage.getItem('fs_'+k)||'[]');
function sl(k,d){
  localStorage.setItem('fs_'+k,JSON.stringify(d));
  if(CFG&&CFG.url&&CFG.key&&TABLES[k])sbPush(k,d);
}
// Push full dataset to Supabase (upsert all rows)
async function sbPush(k,d){
  const tbl=TABLES[k];if(!tbl)return;
  try{
    await fetch(`${CFG.url}/rest/v1/${tbl}?id=gte.0`,{method:'DELETE',
      headers:{'apikey':CFG.key,'Authorization':'Bearer '+CFG.key}});
    if(d.length===0)return;
    // Remap 'from'/'to' ‚Üí 'from_acc'/'to_acc' for fund_transfers (reserved SQL words)
    const rows=k==='xfer'?d.map(r=>({...r,from_acc:r.from,to_acc:r.to,from:undefined,to:undefined})):d;
    await fetch(`${CFG.url}/rest/v1/${tbl}`,{method:'POST',
      headers:{'apikey':CFG.key,'Authorization':'Bearer '+CFG.key,'Content-Type':'application/json','Prefer':'return=minimal'},
      body:JSON.stringify(rows)});
  }catch(e){console.warn('Supabase push failed:',e);}
}
// Pull all data from Supabase into localStorage
async function sbPull(){
  if(!CFG||!CFG.url||!CFG.key)return false;
  try{
    let anyData=false;
    for(const[k,tbl] of Object.entries(TABLES)){
      const r=await fetch(`${CFG.url}/rest/v1/${tbl}?order=id`,{
        headers:{'apikey':CFG.key,'Authorization':'Bearer '+CFG.key}});
      if(!r.ok)continue;
      const data=await r.json();
      if(Array.isArray(data)){
        // Remap from_acc/to_acc back to from/to for fund_transfers
        const mapped=k==='xfer'?data.map(r=>({...r,from:r.from_acc,to:r.to_acc})):data;
        localStorage.setItem('fs_'+k,JSON.stringify(mapped));
        if(data.length>0)anyData=true;
      }
    }
    return anyData;
  }catch(e){console.warn('Supabase pull failed:',e);return false;}
}
const INR=x=>'‚Çπ'+Number(x||0).toLocaleString('en-IN');
const nid=a=>a.length?Math.max(...a.map(x=>+x.id||0))+1:1;
const todayISO=()=>new Date().toISOString().split('T')[0];
function toDMY(d){if(!d||d==='-')return '-';const p=d.split('-');return p[0].length===4?`${p[2]}-${p[1]}-${p[0]}`:d;}
function toISO(d){
  if(!d)return '';
  const s=d.toString().trim();
  // Handle Excel serial date numbers
  if(/^\d{5}$/.test(s)){
    const dt=new Date((+s-25569)*86400*1000);
    return dt.toISOString().split('T')[0];
  }
  const p=s.split(/[-\/]/);
  if(p.length!==3)return '';
  // DD-MM-YYYY ‚Üí YYYY-MM-DD
  if(p[0].length<=2)return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
  return s; // already ISO
}

// ‚ïê‚ïê DRAWER ‚ïê‚ïê
function openDrawer(){
  document.getElementById('sideDrawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
  const du=document.getElementById('drUser');
  if(du&&CU)du.textContent=CU.name+' ¬∑ '+CU.role;
}
function closeDrawer(){
  document.getElementById('sideDrawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
}
function goDr(pg){
  closeDrawer();
  document.querySelectorAll('.di').forEach(el=>el.classList.remove('active'));
  const d=document.getElementById('di-'+pg);if(d)d.classList.add('active');
  go(pg);
}

// ‚ïê‚ïê AUTH ‚ïê‚ïê
function login(){
  const u=v('lu'),p=v('lp');
  if((u==='admin'&&p===CFG.pw1)||(u==='user2'&&p===CFG.pw2)){
    CU={u,name:u==='admin'?'Admin':'Staff',role:u==='admin'?'Owner':'Staff'};
    sessionStorage.setItem('mf_session',JSON.stringify(CU));
    showApp();
  }else $('lerr').textContent='Invalid username or password.';
}
async function showApp(){
  $('loginScreen').style.display='none';$('app').style.display='block';
  $('sbAv').textContent=CU.name[0];$('sbNm').textContent=CU.name;$('sbRl').textContent=CU.role;
  $('mobU').textContent=CU.name;$('lerr').textContent='';
  initDates();loadSettings();
  if(CFG.url&&CFG.key){
    // Show loading state
    toast('‚òÅÔ∏è Syncing from cloud‚Ä¶');
    const pulled=await sbPull();
    if(pulled){
      localStorage.setItem('mf_seeded','1'); // don't seed if cloud has data
      toast('‚úÖ Synced from Supabase','ok');
    }
  }
  if(!localStorage.getItem('mf_seeded')){seedDemo();localStorage.setItem('mf_seeded','1');}
  renderAll();
  if(!CFG.url)setTimeout(()=>toast('‚öôÔ∏è Go to Settings to connect Supabase for cross-device sync'),2000);
}
function logout(){CU=null;sessionStorage.removeItem('mf_session');$('app').style.display='none';$('loginScreen').style.display='flex';}
function checkSession(){const s=sessionStorage.getItem('mf_session');if(s){try{CU=JSON.parse(s);showApp();return true;}catch(e){}}return false;}

// ‚ïê‚ïê NAV ‚ïê‚ïê
function go(pg){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.ni,.mi').forEach(el=>el.classList.remove('active'));
  $('pg-'+pg).classList.add('active');
  [$('ni-'+pg),$('mn-'+pg)].forEach(el=>{if(el)el.classList.add('active');});
  const actions={db:renderDB,gold:()=>renderGold(),hand:()=>renderHand(),inv:renderInv,exp:renderExp,led:renderLed,acc:renderAcc,bkp:updateCounts};
  if(actions[pg])actions[pg]();
}
function openM(id){$(id).classList.add('open');}
function closeM(id){$(id).classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('ov'))e.target.classList.remove('open');});
function toast(msg,t=''){const el=$('toast');el.textContent=msg;el.className='show'+(t?' '+t:'');setTimeout(()=>el.className='',3000);}

// ‚ïê‚ïê SEED DEMO ‚ïê‚ïê
function seedDemo(){
  if(gl('gold').length===0)sl('gold',[
    {id:1,bill:'A-01',date:'2026-02-20',cust:'Henry',addr:'Hixdown Town',phone:'123456789',items:'Ring-1',gw:10,nw:8,loan:10000,rate:1.5,stat:'Open',cg:5000,sg:5000,eg:0,rel:'',ir:0,rc:0,rs:0,re:0},
    {id:2,bill:'A-02',date:'2026-02-21',cust:'Henry',addr:'Hixdown Town',phone:'123456789',items:'Ring-1',gw:10,nw:8,loan:10000,rate:1.5,stat:'Closed',cg:10000,sg:0,eg:0,rel:'2026-02-25',ir:5000,rc:0,rs:15000,re:0},
    {id:3,bill:'A-03',date:'2025-06-01',cust:'Ravi Kumar',addr:'MG Road',phone:'987654321',items:'Necklace',gw:18,nw:15,loan:15000,rate:1.5,stat:'Closed',cg:15000,sg:0,eg:0,rel:'2025-10-01',ir:3375,rc:18375,rs:0,re:0},
    {id:4,bill:'A-04',date:'2025-12-01',cust:'Priya Devi',addr:'Anna Nagar',phone:'876543210',items:'Bangles',gw:22,nw:18,loan:20000,rate:2.0,stat:'Open',cg:0,sg:20000,eg:0,rel:'',ir:0,rc:0,rs:0,re:0},
  ]);
  if(gl('hand').length===0)sl('hand',[
    {id:1,bill:'H-01',date:'2026-02-20',cust:'Henry',phone:'123456789',loan:10000,rate:1.5,stat:'Open',repay:'',cg:10000,sg:0,eg:0,ir:0,rc:0,rs:0,re:0},
    {id:2,bill:'H-02',date:'2026-02-21',cust:'Kumar',phone:'765432109',loan:15000,rate:1.5,stat:'Closed',repay:'2026-02-25',cg:0,sg:15000,eg:0,ir:500,rc:500,rs:15000,re:0},
    {id:3,bill:'H-03',date:'2025-05-01',cust:'Selvam',phone:'654321098',loan:10000,rate:1.5,stat:'Closed',repay:'2025-09-01',cg:10000,sg:0,eg:0,ir:600,rc:10600,rs:0,re:0},
    {id:4,bill:'H-04',date:'2025-11-01',cust:'Anbu Raja',phone:'543210987',loan:20000,rate:2.0,stat:'Open',repay:'',cg:20000,sg:0,eg:0,ir:0,rc:0,rs:0,re:0},
  ]);
  if(gl('inv').length===0)sl('inv',[
    {id:1,date:'2026-02-20',part:'Partner1',amt:10000,stat:'Open',cmt:'Initial',ci:10000,si:0,ei:0},
    {id:2,date:'2026-02-20',part:'Partner2',amt:10000,stat:'Open',cmt:'Initial',ci:0,si:10000,ei:0},
    {id:3,date:'2026-02-20',part:'Partner3',amt:10000,stat:'Open',cmt:'Initial',ci:0,si:0,ei:10000},
  ]);
  if(gl('exp').length===0)sl('exp',[
    {id:1,date:'2026-02-25',name:'Office Rent',amt:5000,cmt:'Monthly',co:5000,so:0,eo:0},
    {id:2,date:'2026-02-26',name:'Electricity',amt:1000,cmt:'',co:0,so:1000,eo:0},
  ]);
}

// ‚ïê‚ïê BALANCE ENGINE ‚ïê‚ïê
function calcInt(loan,rate,dateStr){if(!loan||!rate||!dateStr)return 0;const s=new Date(dateStr),now=new Date();const m=Math.max(0,(now.getFullYear()-s.getFullYear())*12+(now.getMonth()-s.getMonth()));return Math.round(loan*(rate/100)*m);}
function autoCash(total,sg,eg){return Math.max(0,total-sg-eg);}
function allTxns(){
  const t=[];
  for(const g of gl('gold')){
    t.push({date:g.date,type:'Gold Loan Given',desc:`${g.bill} ‚Äî ${g.cust}`,total:-g.loan,cash:-(+g.cg||0),sg:-(+g.sg||0),eg:-(+g.eg||0),dir:'out'});
    if(g.stat==='Closed'&&g.rel)t.push({date:g.rel,type:'Gold Loan Closed',desc:`${g.bill} ‚Äî ${g.cust}`,total:(+g.loan)+(+g.ir||0),cash:+(+g.rc||0),sg:+(+g.rs||0),eg:+(+g.re||0),dir:'in'});
  }
  for(const h of gl('hand')){
    t.push({date:h.date,type:'Hand Loan Given',desc:`${h.bill} ‚Äî ${h.cust}`,total:-h.loan,cash:-(+h.cg||0),sg:-(+h.sg||0),eg:-(+h.eg||0),dir:'out'});
    if(h.stat==='Closed'&&h.repay)t.push({date:h.repay,type:'Hand Loan Closed',desc:`${h.bill} ‚Äî ${h.cust}`,total:(+h.loan)+(+h.ir||0),cash:+(+h.rc||0),sg:+(+h.rs||0),eg:+(+h.re||0),dir:'in'});
  }
  for(const i of gl('inv'))t.push({date:i.date,type:'Investment',desc:i.part,total:+i.amt,cash:+(+i.ci||0),sg:+(+i.si||0),eg:+(+i.ei||0),dir:'in'});
  for(const e of gl('exp'))t.push({date:e.date,type:'Expense',desc:e.name,total:-e.amt,cash:-(+e.co||0),sg:-(+e.so||0),eg:-(+e.eo||0),dir:'out'});
  // Fund transfers ‚Äî net zero total but shift between accounts
  for(const x of gl('xfer')){
    const cd={cash:0,sg:0,eg:0};
    cd[x.from]-=+x.amt;cd[x.to]+=+x.amt;
    t.push({date:x.date,type:'Fund Transfer',desc:x.rem||`${lblAcc(x.from)} ‚Üí ${lblAcc(x.to)}`,total:0,cash:cd.cash,sg:cd.sg,eg:cd.eg,dir:'xfer',xid:x.id});
  }
  return t.sort((a,b)=>a.date.localeCompare(b.date));
}
function lblAcc(k){return k==='sg'?'SG Phone':k==='eg'?'EG Phone':'Cash';}
function computeBal(upto=null){
  let cash=+(CFG.obC||0),sg=+(CFG.obS||0),eg=+(CFG.obE||0);
  for(const t of allTxns()){if(upto&&t.date>upto)continue;cash+=t.cash;sg+=t.sg;eg+=t.eg;}
  return{cash,sg,eg,total:cash+sg+eg};
}

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê
function renderAll(){renderDB();renderGold();renderHand();renderInv();renderExp();}
function renderDB(){
  const gold=gl('gold'),hand=gl('hand'),inv=gl('inv'),exp=gl('exp');
  const og=gold.filter(x=>x.stat==='Open'),ogc=gold.filter(x=>x.stat==='Closed');
  const oh=hand.filter(x=>x.stat==='Open'),ohc=hand.filter(x=>x.stat==='Closed');
  const bal=computeBal();
  const now=new Date();
  $('dbDate').textContent=now.toLocaleDateString('en-IN',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  const totInv=inv.reduce((a,b)=>a+(+b.amt||0),0);
  const totExp=exp.reduce((a,b)=>a+(+b.amt||0),0);
  const netAmt=totInv-totExp;
  const gOI=og.reduce((a,b)=>a+calcInt(b.loan,b.rate,b.date),0);
  const gCI=ogc.reduce((a,b)=>a+(+b.ir||0),0);
  const hOI=oh.reduce((a,b)=>a+calcInt(b.loan,b.rate,b.date),0);
  const hCI=ohc.reduce((a,b)=>a+(+b.ir||0),0);
  $('ahero').innerHTML=`
    <div class="ahc"><div class="ahc-lbl">üíµ Cash Balance</div><div class="ahc-val">${INR(bal.cash)}</div><div class="ahc-sub">Available cash</div></div>
    <div class="ahc"><div class="ahc-lbl">üè¶ SG Phone Pay</div><div class="ahc-val">${INR(bal.sg)}</div><div class="ahc-sub">Account balance</div></div>
    <div class="ahc"><div class="ahc-lbl">üè¶ EG Phone Pay</div><div class="ahc-val">${INR(bal.eg)}</div><div class="ahc-sub">Account balance</div></div>`;
  $('scards').innerHTML=`
    <div class="sc"><div class="sc-lbl">Total Investment</div><div class="sc-val y">${INR(totInv)}</div><div class="sc-sub">${inv.length} partners</div></div>
    <div class="sc"><div class="sc-lbl">Total Expenses</div><div class="sc-val r">${INR(totExp)}</div><div class="sc-sub">${exp.length} entries</div></div>
    <div class="sc"><div class="sc-lbl">Net Amount</div><div class="sc-val ${netAmt>=0?'gr':'r'}">${INR(netAmt)}</div></div>
    <div class="sc"><div class="sc-lbl">Shop Balance</div><div class="sc-val g">${INR(bal.total)}</div></div>
    <div class="sc"><div class="sc-lbl">Open Gold Bills</div><div class="sc-val y">${og.length}</div><div class="sc-sub">${INR(og.reduce((a,b)=>a+(+b.loan||0),0))}</div></div>
    <div class="sc"><div class="sc-lbl">Open Hand Loans</div><div class="sc-val y">${oh.length}</div><div class="sc-sub">${INR(oh.reduce((a,b)=>a+(+b.loan||0),0))}</div></div>`;
  $('dblocks').innerHTML=`
    <div class="db"><div class="db-hd"><div class="db-dot" style="background:var(--y1)"></div><h3>Investments & Expenses</h3></div>
      <div class="db-row"><span class="k">Total Invested</span><span class="v y">${INR(totInv)}</span></div>
      ${inv.map(i=>`<div class="db-row"><span class="k">&nbsp;&nbsp;${i.part}</span><span class="v">${INR(i.amt)}</span></div>`).join('')}
      <div class="db-div"></div>
      <div class="db-row"><span class="k">Total Expenses</span><span class="v r">${INR(totExp)}</span></div>
      <div class="db-row" style="background:var(--gp)"><span class="k" style="font-weight:700">Net Amount</span><span class="v ${netAmt>=0?'gr':'r'}">${INR(netAmt)}</span></div>
      <div class="db-row"><span class="k">Balance in Shop</span><span class="v g">${INR(bal.total)}</span></div>
    </div>
    <div class="db"><div class="db-hd"><div class="db-dot" style="background:var(--g2)"></div><h3>Gold Loan Transactions</h3></div>
      <div class="db-row"><span class="k">Open Bills</span><span class="v y">${og.length}</span></div>
      <div class="db-row"><span class="k">Open Amount</span><span class="v">${INR(og.reduce((a,b)=>a+(+b.loan||0),0))}</span></div>
      <div class="db-row"><span class="k">Interest Due (Open)</span><span class="v gr">${INR(gOI)}</span></div>
      <div class="db-div"></div>
      <div class="db-row"><span class="k">Closed Bills</span><span class="v">${ogc.length}</span></div>
      <div class="db-row"><span class="k">Interest Earned</span><span class="v gr">${INR(gCI)}</span></div>
    </div>
    <div class="db"><div class="db-hd"><div class="db-dot" style="background:var(--b1)"></div><h3>Hand Loan Transactions</h3></div>
      <div class="db-row"><span class="k">Outside Amount (Open)</span><span class="v y">${INR(oh.reduce((a,b)=>a+(+b.loan||0),0))}</span></div>
      <div class="db-row"><span class="k">Interest Due (Open)</span><span class="v gr">${INR(hOI)}</span></div>
      <div class="db-div"></div>
      <div class="db-row"><span class="k">Closed Loans</span><span class="v">${ohc.length}</span></div>
      <div class="db-row"><span class="k">Interest Earned</span><span class="v gr">${INR(hCI)}</span></div>
    </div>`;
  $('dgold').innerHTML=gold.slice(-5).reverse().map(x=>`<tr><td><strong>${x.bill}</strong></td><td>${x.cust}</td><td>${INR(x.loan)}</td><td><span class="badge ${x.stat==='Open'?'bo':'bc'}">${x.stat}</span></td></tr>`).join('')||`<tr><td colspan="4" class="nd">No records</td></tr>`;
  $('dhand').innerHTML=hand.slice(-5).reverse().map(x=>`<tr><td><strong>${x.bill}</strong></td><td>${x.cust}</td><td>${INR(x.loan)}</td><td><span class="badge ${x.stat==='Open'?'bo':'bc'}">${x.stat}</span></td></tr>`).join('')||`<tr><td colspan="4" class="nd">No records</td></tr>`;
}

// ‚ïê‚ïê COLUMN TOGGLE ‚ïê‚ïê
function toggleColMenu(id){
  const m=document.getElementById(id);
  m.style.display=m.style.display==='block'?'none':'block';
  // close on outside click
  setTimeout(()=>{document.addEventListener('click',function h(e){
    if(!m.contains(e.target)&&!m.previousElementSibling.contains(e.target)){m.style.display='none';document.removeEventListener('click',h);}
  });},0);
}
function togGCol(col){
  gCols[col]=!gCols[col];
  // update checkbox
  const cb=document.getElementById('gc_'+col);if(cb)cb.checked=gCols[col];
  renderGold();
}
function togHCol(col){
  hCols[col]=!hCols[col];
  const cb=document.getElementById('hc_'+col);if(cb)cb.checked=hCols[col];
  renderHand();
}

// ‚ïê‚ïê GOLD LOANS ‚ïê‚ïê
function filterGold(rows){
  const f=(v('gSearch')||'').toLowerCase();
  const fr=v('gFrom'),to=v('gTo'),st=v('gStat2');
  return rows.filter(x=>{
    if(f&&!(`${x.bill} ${x.cust} ${x.phone}`).toLowerCase().includes(f))return false;
    if(fr&&x.date<fr)return false;
    if(to&&x.date>to)return false;
    if(st&&x.stat!==st)return false;
    return true;
  });
}
function applyGoldFilter(){renderGold();}
function clearGoldFilter(){['gSearch','gFrom','gTo'].forEach(id=>$(id).value='');$('gStat2').value='';renderGold();}
function renderGold(){
  const rows=filterGold(gl('gold'));
  const open=rows.filter(r=>r.stat==='Open'),closed=rows.filter(r=>r.stat==='Closed');
  const totLoan=rows.reduce((a,r)=>a+(+r.loan||0),0);
  const totGW=rows.reduce((a,r)=>a+(+r.gw||0),0);
  const totNW=rows.reduce((a,r)=>a+(+r.nw||0),0);
  const openLoan=open.reduce((a,r)=>a+(+r.loan||0),0);
  const intDue=open.reduce((a,r)=>a+calcInt(r.loan,r.rate,r.date),0);
  const intEarned=closed.reduce((a,r)=>a+(+r.ir||0),0);
  // Summary ‚Äî updates based on current filter
  $('goldSummary').innerHTML=`
    <div class="smc"><div class="smc-l">Total Bills</div><div class="smc-v">${rows.length}</div></div>
    <div class="smc"><div class="smc-l">Open Bills</div><div class="smc-v" style="color:var(--b1)">${open.length}</div></div>
    <div class="smc"><div class="smc-l">Closed Bills</div><div class="smc-v" style="color:var(--txt3)">${closed.length}</div></div>
    <div class="smc"><div class="smc-l">Total Loan Amt</div><div class="smc-v">${INR(totLoan)}</div></div>
    <div class="smc"><div class="smc-l">Open Loan Amt</div><div class="smc-v" style="color:var(--b1)">${INR(openLoan)}</div></div>
    <div class="smc"><div class="smc-l">Gross Wt (g)</div><div class="smc-v">${totGW}g</div></div>
    <div class="smc"><div class="smc-l">Net Wt (g)</div><div class="smc-v">${totNW}g</div></div>
    <div class="smc"><div class="smc-l">Interest Due (Open)</div><div class="smc-v" style="color:var(--y1)">${INR(intDue)}</div></div>
    <div class="smc"><div class="smc-l">Interest Earned (Closed)</div><div class="smc-v" style="color:var(--g2)">${INR(intEarned)}</div></div>`;
  const c=gCols;
  $('goldHead').innerHTML=`<tr>
    <th>#</th><th>Bill No</th><th>Date</th><th>Customer</th>
    ${c.phone?'<th>Phone</th>':''}
    ${c.addr?'<th>Address</th>':''}
    <th>Items</th>
    ${c.gw?'<th>Gr.Wt</th>':''}
    ${c.nw?'<th>Nt.Wt</th>':''}
    <th>Loan ‚Çπ</th>
    ${c.rate?'<th>Rate%</th>':''}
    <th>Interest Till Date ‚Çπ</th>
    <th>Interest Received ‚Çπ</th>
    <th>Release Date</th>
    ${c.cash?'<th>Cash ‚Çπ</th>':''}
    ${c.sg?'<th>SG Phone ‚Çπ</th>':''}
    ${c.eg?'<th>EG Phone ‚Çπ</th>':''}
    <th>Status</th><th>Actions</th></tr>`;
  $('goldTbl').innerHTML=rows.map((x,i)=>{
    const isOpen=x.stat==='Open';
    const intTillDate=isOpen?calcInt(x.loan,x.rate,x.date):0;
    const intReceived=!isOpen?(+x.ir||0):0;
    return`<tr>
      <td>${i+1}</td><td><strong>${x.bill}</strong></td><td>${toDMY(x.date)}</td><td>${x.cust}</td>
      ${c.phone?`<td>${x.phone||'-'}</td>`:''}
      ${c.addr?`<td>${x.addr||'-'}</td>`:''}
      <td>${x.items||'-'}</td>
      ${c.gw?`<td>${x.gw}g</td>`:''}
      ${c.nw?`<td>${x.nw}g</td>`:''}
      <td><strong>${INR(x.loan)}</strong></td>
      ${c.rate?`<td>${x.rate}%</td>`:''}
      <td style="color:${isOpen?'var(--y1)':'var(--txt4)'};font-weight:600">${isOpen?INR(intTillDate):'‚Äî'}</td>
      <td style="color:${!isOpen?'var(--g2)':'var(--txt4)'};font-weight:600">${!isOpen?INR(intReceived):'‚Äî'}</td>
      <td style="color:var(--txt2)">${toDMY(x.rel)||'‚Äî'}</td>
      ${c.cash?`<td>${INR(x.cg||0)}</td>`:''}
      ${c.sg?`<td>${INR(x.sg||0)}</td>`:''}
      ${c.eg?`<td>${INR(x.eg||0)}</td>`:''}
      <td><span class="badge ${isOpen?'bo':'bc'}">${x.stat}</span></td>
      <td><div style="display:flex;gap:4px"><button class="btn btn-b btn-sm" onclick="editGold(${x.id})">Edit</button><button class="btn btn-r btn-sm" onclick="del('gold',${x.id})">Del</button></div></td></tr>`;
  }).join('')||`<tr><td colspan="22" class="nd">No gold loans found.</td></tr>`;
}
function openGM(){clearGF();openM('gModal');}
function clearGF(){
  $('gId').value='';$('gMT').textContent='New Gold Loan Bill';
  ['gBill','gAddr','gItems','gCust','gPhone','gGW','gNW','gRD','gIR','gRC','gRS','gRE','gLoan','gCash','gSG','gEG'].forEach(id=>{if($(id))$(id).value='';});
  $('gDate').value=todayISO();$('gRate').value='1.5';$('gStat').value='Open';tGC();
}
function tGC(){$('gCD').style.display=$('gStat').value==='Closed'?'block':'none';}
function tHC(){$('hCD').style.display=$('hStat').value==='Closed'?'block':'none';}
function updS(p){
  const m={g:{t:'gLoan',s:'gSG',e:'gEG',r:'gRem'},h:{t:'hLoan',s:'hSG',e:'hEG',r:'hRem'},i:{t:'iAmt',s:'iSG',e:'iEG',r:'iRem'},e:{t:'eAmt',s:'eSG',e:'eEG',r:'eRem'}};
  const x=m[p];if(!x)return;
  $(x.r).textContent=`Cash auto: ${INR(autoCash(n(x.t),n(x.s),n(x.e)))}`;
}
function updCS(p){
  const m={g:{l:'gLoan',i:'gIR',s:'gRS',e:'gRE',r:'gRRem'},h:{l:'hLoan',i:'hIR',s:'hRS',e:'hRE',r:'hRRem'}};
  const x=m[p];if(!x)return;
  $(x.r).textContent=`Cash auto: ${INR(autoCash(n(x.l)+n(x.i),n(x.s),n(x.e)))}`;
}
function editGold(xid){
  const x=gl('gold').find(r=>r.id===xid);if(!x)return;
  $('gId').value=x.id;$('gMT').textContent='Edit Gold Loan';
  $('gBill').value=x.bill;$('gDate').value=x.date;$('gCust').value=x.cust;$('gPhone').value=x.phone;$('gAddr').value=x.addr||'';$('gItems').value=x.items;$('gGW').value=x.gw;$('gNW').value=x.nw;$('gLoan').value=x.loan;$('gRate').value=x.rate;$('gStat').value=x.stat;
  $('gCash').value=x.cg||'';$('gSG').value=x.sg||'';$('gEG').value=x.eg||'';
  $('gRD').value=x.rel||'';$('gIR').value=x.ir||'';$('gRC').value=x.rc||'';$('gRS').value=x.rs||'';$('gRE').value=x.re||'';
  tGC();openM('gModal');
}
function saveGold(){
  const eid=$('gId').value;
  const loan=n('gLoan'),sg=n('gSG'),eg=n('gEG'),cash=n('gCash')||autoCash(loan,sg,eg);
  const rLoan=n('gLoan'),rInt=n('gIR'),rSG=n('gRS'),rEG=n('gRE'),rCash=n('gRC')||autoCash(rLoan+rInt,rSG,rEG);
  const obj={id:eid?+eid:nid(gl('gold')),bill:v('gBill').trim(),date:v('gDate'),cust:v('gCust').trim(),addr:v('gAddr').trim(),phone:v('gPhone').trim(),items:v('gItems').trim(),gw:n('gGW'),nw:n('gNW'),loan,rate:n('gRate')||1.5,stat:v('gStat'),cg:cash,sg,eg,rel:v('gRD'),ir:n('gIR'),rc:rCash,rs:rSG,re:rEG};
  if(!obj.bill||!obj.cust)return toast('Fill Bill No and Customer Name','err');
  let data=gl('gold');if(eid)data=data.map(r=>r.id===+eid?obj:r);else data.push(obj);
  sl('gold',data);closeM('gModal');renderGold();renderDB();toast('Gold loan saved!','ok');
}

// ‚ïê‚ïê HAND LOANS ‚ïê‚ïê
function filterHand(rows){
  const f=(v('hSearch')||'').toLowerCase();
  const fr=v('hFrom'),to=v('hTo'),st=v('hStat2');
  return rows.filter(x=>{
    if(f&&!(`${x.bill} ${x.cust} ${x.phone}`).toLowerCase().includes(f))return false;
    if(fr&&x.date<fr)return false;
    if(to&&x.date>to)return false;
    if(st&&x.stat!==st)return false;
    return true;
  });
}
function applyHandFilter(){renderHand();}
function clearHandFilter(){['hSearch','hFrom','hTo'].forEach(id=>$(id).value='');$('hStat2').value='';renderHand();}
function renderHand(){
  const rows=filterHand(gl('hand'));
  const open=rows.filter(r=>r.stat==='Open'),closed=rows.filter(r=>r.stat==='Closed');
  const totLoan=rows.reduce((a,r)=>a+(+r.loan||0),0);
  const openLoan=open.reduce((a,r)=>a+(+r.loan||0),0);
  const intDue=open.reduce((a,r)=>a+calcInt(r.loan,r.rate,r.date),0);
  const intEarned=closed.reduce((a,r)=>a+(+r.ir||0),0);
  $('handSummary').innerHTML=`
    <div class="smc"><div class="smc-l">Total Loans</div><div class="smc-v">${rows.length}</div></div>
    <div class="smc"><div class="smc-l">Open Loans</div><div class="smc-v" style="color:var(--b1)">${open.length}</div></div>
    <div class="smc"><div class="smc-l">Closed Loans</div><div class="smc-v" style="color:var(--txt3)">${closed.length}</div></div>
    <div class="smc"><div class="smc-l">Total Loan Amt</div><div class="smc-v">${INR(totLoan)}</div></div>
    <div class="smc"><div class="smc-l">Open Loan Amt</div><div class="smc-v" style="color:var(--b1)">${INR(openLoan)}</div></div>
    <div class="smc"><div class="smc-l">Interest Due (Open)</div><div class="smc-v" style="color:var(--y1)">${INR(intDue)}</div></div>
    <div class="smc"><div class="smc-l">Interest Earned (Closed)</div><div class="smc-v" style="color:var(--g2)">${INR(intEarned)}</div></div>`;
  const c=hCols;
  $('handHead').innerHTML=`<tr>
    <th>#</th><th>Bill No</th><th>Date</th><th>Customer</th>
    ${c.phone?'<th>Phone</th>':''}
    <th>Loan ‚Çπ</th>
    ${c.rate?'<th>Rate%</th>':''}
    <th>Interest Till Date ‚Çπ</th>
    <th>Interest Received ‚Çπ</th>
    <th>Repay Date</th>
    ${c.cash?'<th>Cash ‚Çπ</th>':''}
    ${c.sg?'<th>SG Phone ‚Çπ</th>':''}
    ${c.eg?'<th>EG Phone ‚Çπ</th>':''}
    <th>Status</th><th>Actions</th></tr>`;
  $('handTbl').innerHTML=rows.map((x,i)=>{
    const isOpen=x.stat==='Open';
    const intTillDate=isOpen?calcInt(x.loan,x.rate,x.date):0;
    const intReceived=!isOpen?(+x.ir||0):0;
    return`<tr>
      <td>${i+1}</td><td><strong>${x.bill}</strong></td><td>${toDMY(x.date)}</td><td>${x.cust}</td>
      ${c.phone?`<td>${x.phone||'-'}</td>`:''}
      <td><strong>${INR(x.loan)}</strong></td>
      ${c.rate?`<td>${x.rate}%</td>`:''}
      <td style="color:${isOpen?'var(--y1)':'var(--txt4)'};font-weight:600">${isOpen?INR(intTillDate):'‚Äî'}</td>
      <td style="color:${!isOpen?'var(--g2)':'var(--txt4)'};font-weight:600">${!isOpen?INR(intReceived):'‚Äî'}</td>
      <td style="color:var(--txt2)">${toDMY(x.repay)||'‚Äî'}</td>
      ${c.cash?`<td>${INR(x.cg||0)}</td>`:''}
      ${c.sg?`<td>${INR(x.sg||0)}</td>`:''}
      ${c.eg?`<td>${INR(x.eg||0)}</td>`:''}
      <td><span class="badge ${isOpen?'bo':'bc'}">${x.stat}</span></td>
      <td><div style="display:flex;gap:4px"><button class="btn btn-b btn-sm" onclick="editHand(${x.id})">Edit</button><button class="btn btn-r btn-sm" onclick="del('hand',${x.id})">Del</button></div></td></tr>`;
  }).join('')||`<tr><td colspan="17" class="nd">No hand loans found.</td></tr>`;
}
function openHM(){
  ['hId','hBill','hCust','hPhone','hRD2','hRelD','hIR','hRC','hRS','hRE','hLoan','hCash','hSG','hEG'].forEach(id=>{if($(id))$(id).value='';});
  $('hMT').textContent='New Hand Loan';$('hDate').value=todayISO();$('hRate').value='1.5';$('hStat').value='Open';tHC();openM('hModal');
}
function editHand(xid){
  const x=gl('hand').find(r=>r.id===xid);if(!x)return;
  $('hId').value=x.id;$('hMT').textContent='Edit Hand Loan';
  $('hBill').value=x.bill;$('hDate').value=x.date;$('hCust').value=x.cust;$('hPhone').value=x.phone;$('hLoan').value=x.loan;$('hRate').value=x.rate;$('hStat').value=x.stat;$('hRD2').value=x.repay||'';
  $('hCash').value=x.cg||'';$('hSG').value=x.sg||'';$('hEG').value=x.eg||'';
  $('hRelD').value=x.repay||'';$('hIR').value=x.ir||'';$('hRC').value=x.rc||'';$('hRS').value=x.rs||'';$('hRE').value=x.re||'';
  tHC();openM('hModal');
}
function saveHand(){
  const eid=$('hId').value;
  const loan=n('hLoan'),sg=n('hSG'),eg=n('hEG'),cash=n('hCash')||autoCash(loan,sg,eg);
  const rLoan=n('hLoan'),rInt=n('hIR'),rSG=n('hRS'),rEG=n('hRE'),rCash=n('hRC')||autoCash(rLoan+rInt,rSG,rEG);
  const obj={id:eid?+eid:nid(gl('hand')),bill:v('hBill').trim(),date:v('hDate'),cust:v('hCust').trim(),phone:v('hPhone').trim(),loan,rate:n('hRate')||1.5,stat:v('hStat'),repay:v('hRelD')||v('hRD2'),cg:cash,sg,eg,ir:n('hIR'),rc:rCash,rs:rSG,re:rEG};
  if(!obj.bill||!obj.cust)return toast('Fill Bill No and Customer Name','err');
  let data=gl('hand');if(eid)data=data.map(r=>r.id===+eid?obj:r);else data.push(obj);
  sl('hand',data);closeM('hModal');renderHand();renderDB();toast('Hand loan saved!','ok');
}

// ‚ïê‚ïê INVESTMENTS ‚ïê‚ïê
function renderInv(){$('invTbl').innerHTML=gl('inv').map((x,i)=>`<tr><td>${i+1}</td><td>${toDMY(x.date)}</td><td>${x.part}</td><td>${INR(x.amt)}</td><td>${INR(x.ci)}</td><td>${INR(x.si)}</td><td>${INR(x.ei)}</td><td><span class="badge bi">${x.stat}</span></td><td>${x.cmt||'-'}</td><td><div style="display:flex;gap:4px"><button class="btn btn-b btn-sm" onclick="editInv(${x.id})">Edit</button><button class="btn btn-r btn-sm" onclick="del('inv',${x.id})">Del</button></div></td></tr>`).join('')||`<tr><td colspan="10" class="nd">No investments.</td></tr>`;}
function openIM(){['iId','iPart','iAmt','iCmt','iCash','iSG','iEG'].forEach(id=>{if($(id))$(id).value='';}); $('iDate').value=todayISO();$('iStat').value='Open';openM('iModal');}
function editInv(xid){const x=gl('inv').find(r=>r.id===xid);if(!x)return;$('iId').value=x.id;$('iDate').value=x.date;$('iPart').value=x.part;$('iAmt').value=x.amt;$('iStat').value=x.stat;$('iCmt').value=x.cmt||'';$('iCash').value=x.ci||'';$('iSG').value=x.si||'';$('iEG').value=x.ei||'';openM('iModal');}
function saveInv(){
  const eid=$('iId').value,amt=n('iAmt'),sg=n('iSG'),eg=n('iEG'),cash=n('iCash')||autoCash(amt,sg,eg);
  const obj={id:eid?+eid:nid(gl('inv')),date:v('iDate'),part:v('iPart').trim(),amt,stat:v('iStat'),cmt:v('iCmt').trim(),ci:cash,si:sg,ei:eg};
  if(!obj.part||!obj.amt)return toast('Fill Partner and Amount','err');
  let data=gl('inv');if(eid)data=data.map(r=>r.id===+eid?obj:r);else data.push(obj);
  sl('inv',data);closeM('iModal');renderInv();renderDB();toast('Investment saved!','ok');
}

// ‚ïê‚ïê EXPENSES ‚ïê‚ïê
function renderExp(){$('expTbl').innerHTML=gl('exp').map((x,i)=>`<tr><td>${i+1}</td><td>${toDMY(x.date)}</td><td>${x.name}</td><td>${INR(x.amt)}</td><td>${INR(x.co)}</td><td>${INR(x.so)}</td><td>${INR(x.eo)}</td><td>${x.cmt||'-'}</td><td><div style="display:flex;gap:4px"><button class="btn btn-b btn-sm" onclick="editExp(${x.id})">Edit</button><button class="btn btn-r btn-sm" onclick="del('exp',${x.id})">Del</button></div></td></tr>`).join('')||`<tr><td colspan="9" class="nd">No expenses.</td></tr>`;}
function openEM(){['eId','eName','eAmt','eCmt','eCash','eSG','eEG'].forEach(id=>{if($(id))$(id).value='';}); $('eDate').value=todayISO();openM('eModal');}
function editExp(xid){const x=gl('exp').find(r=>r.id===xid);if(!x)return;$('eId').value=x.id;$('eDate').value=x.date;$('eName').value=x.name;$('eAmt').value=x.amt;$('eCmt').value=x.cmt||'';$('eCash').value=x.co||'';$('eSG').value=x.so||'';$('eEG').value=x.eo||'';openM('eModal');}
function saveExp(){
  const eid=$('eId').value,amt=n('eAmt'),sg=n('eSG'),eg=n('eEG'),cash=n('eCash')||autoCash(amt,sg,eg);
  const obj={id:eid?+eid:nid(gl('exp')),date:v('eDate'),name:v('eName').trim(),amt,cmt:v('eCmt').trim(),co:cash,so:sg,eo:eg};
  if(!obj.name||!obj.amt)return toast('Fill Name and Amount','err');
  let data=gl('exp');if(eid)data=data.map(r=>r.id===+eid?obj:r);else data.push(obj);
  sl('exp',data);closeM('eModal');renderExp();renderDB();toast('Expense saved!','ok');
}
function del(t,xid){if(!confirm('Delete this record?'))return;sl(t,gl(t).filter(r=>r.id!==xid));renderAll();toast('Record deleted.');}

// ‚ïê‚ïê BULK ENTRY ‚ïê‚ïê
function addBR(type){
  const maps={g:'bGold',h:'bHand',gc:'bGC',hc:'bHC',e:'bExp',i:'bInv'};
  const cont=$(maps[type]);
  const rid='r'+Date.now();
  const bi=(ph,tp='text')=>`<input class="bi2" type="${tp}" placeholder="${ph}" oninput="calcImpact()">`;
  const bn=ph=>`<input class="bi2" type="number" placeholder="${ph}" oninput="calcImpact()">`;
  const rm=`<button class="rmb" onclick="document.getElementById('${rid}').remove();calcImpact()">√ó</button>`;
  let html='';
  if(type==='g')
    html=`<div class="bf gf" id="${rid}">${bi('A-0X')}${bi('Date','date')}${bi('Name|Phone|Addr|Items')}${bn('Loan Amt')}${bn('GrWt')}${bn('NtWt')}${bn('1.5')}${bn('SG Phone')}${bn('EG Phone')}${rm}</div>`;
  else if(type==='h')
    html=`<div class="bf hf" id="${rid}">${bi('H-0X')}${bi('Date','date')}${bi('Name|Phone')}${bn('Loan Amt')}${bn('1.5')}${bn('SG Phone')}${bn('EG Phone')}${rm}</div>`;
  else if(type==='gc'||type==='hc'){
    // Bill No | Loan Date (auto-filled readonly) | Loan Amt (auto-filled) | Interest | SG | EG | Status dropdown | del
    const key=type==='gc'?'gold':'hand';
    html=`<div class="bf clf" id="${rid}">
      <input class="bi2" type="text" placeholder="Bill No" onblur="lookupLoan(this,'${key}','${rid}')" oninput="calcImpact()">
      <input class="bi2 ro" type="text" placeholder="Loan Date" readonly id="${rid}_ld">
      <input class="bi2 ro" type="number" placeholder="Loan Amt" readonly id="${rid}_la">
      ${bn('Interest Recd')}${bn('SG Phone')}${bn('EG Phone')}
      <select class="bi2" onchange="calcImpact()"><option value="Closed">Closed</option><option value="Open">Open (Partial)</option></select>
      ${rm}</div>`;
  }
  else if(type==='e'||type==='i')
    html=`<div class="bf eif" id="${rid}">${bi(type==='e'?'Expense Name':'Partner Name')}${bn('Amount')}${bn('Cash')}${bn('SG Phone')}${bn('EG Phone')}${rm}</div>`;
  cont.insertAdjacentHTML('beforeend',html);
  // Set date fields to bulkDate
  const newEl=$(rid);
  newEl.querySelectorAll('input[type=date]').forEach(el=>el.value=v('bulkDate')||todayISO());
}

// Auto-lookup bill details in closed sections
function lookupLoan(billInput,key,rid){
  const billNo=billInput.value.trim();
  if(!billNo)return;
  const rec=gl(key).find(r=>r.bill.toLowerCase()===billNo.toLowerCase());
  if(rec){
    const ldEl=document.getElementById(rid+'_ld');
    const laEl=document.getElementById(rid+'_la');
    if(ldEl)ldEl.value=toDMY(rec.date);
    if(laEl)laEl.value=rec.loan;
    calcImpact();
    toast(`Found: ${rec.cust} ‚Äî Loan ${INR(rec.loan)}`,'ok');
  }else{
    const ldEl=document.getElementById(rid+'_ld');
    const laEl=document.getElementById(rid+'_la');
    if(ldEl)ldEl.value='Not found';
    if(laEl)laEl.value='';
  }
}

function calcImpact(){
  let cash=0,sg=0,eg=0;
  document.querySelectorAll('#bGold .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const loan=+ins[3]?.value||0,sgv=+ins[7]?.value||0,egv=+ins[8]?.value||0;
    cash-=autoCash(loan,sgv,egv);sg-=sgv;eg-=egv;
  });
  document.querySelectorAll('#bHand .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const loan=+ins[3]?.value||0,sgv=+ins[5]?.value||0,egv=+ins[6]?.value||0;
    cash-=autoCash(loan,sgv,egv);sg-=sgv;eg-=egv;
  });
  document.querySelectorAll('#bGC .bf,#bHC .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input:not([readonly])')];
    // interest=ins[0], sg=ins[1], eg=ins[2]
    const int=+ins[0]?.value||0,sgv=+ins[1]?.value||0,egv=+ins[2]?.value||0;
    const laEl=row.querySelector('[id$="_la"]');
    const loan=laEl?+laEl.value||0:0;
    const total=loan+int;
    const cv=autoCash(total,sgv,egv);cash+=cv;sg+=sgv;eg+=egv;
  });
  document.querySelectorAll('#bExp .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const amt=+ins[1]?.value||0,cv=+ins[2]?.value||0,sgv=+ins[3]?.value||0,egv=+ins[4]?.value||0;
    const ac=cv||autoCash(amt,sgv,egv);cash-=ac;sg-=sgv;eg-=egv;
  });
  document.querySelectorAll('#bInv .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const amt=+ins[1]?.value||0,cv=+ins[2]?.value||0,sgv=+ins[3]?.value||0,egv=+ins[4]?.value||0;
    const ac=cv||autoCash(amt,sgv,egv);cash+=ac;sg+=sgv;eg+=egv;
  });
  const fmt=val=>{const c=val>0?'pos':val<0?'neg':'neu';return`<span class="${c}">${val>0?'+':''}${INR(val)}</span>`;};
  $('impC').innerHTML=fmt(cash);$('impS').innerHTML=fmt(sg);$('impE').innerHTML=fmt(eg);
}

function saveBulk(){
  const bdate=v('bulkDate')||todayISO();
  let saved=0;
  // Gold Given
  document.querySelectorAll('#bGold .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const bill=ins[0]?.value.trim(),dt=ins[1]?.value||bdate;
    const raw=ins[2]?.value||'',pts=raw.split('|');
    const cust=(pts[0]||'').trim(),phone=(pts[1]||'').trim(),addr=(pts[2]||'').trim(),items=(pts[3]||'').trim();
    const loan=+ins[3]?.value||0,gw=+ins[4]?.value||0,nw=+ins[5]?.value||0,rate=+ins[6]?.value||1.5;
    const sgv=+ins[7]?.value||0,egv=+ins[8]?.value||0;
    if(!bill||!cust||!loan)return;
    const d=gl('gold');d.push({id:nid(d),bill,date:dt,cust,addr,phone,items,gw,nw,loan,rate,stat:'Open',cg:autoCash(loan,sgv,egv),sg:sgv,eg:egv,rel:'',ir:0,rc:0,rs:0,re:0});sl('gold',d);saved++;
  });
  // Hand Given
  document.querySelectorAll('#bHand .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const bill=ins[0]?.value.trim(),dt=ins[1]?.value||bdate;
    const raw=ins[2]?.value||'',pts=raw.split('|');
    const cust=(pts[0]||'').trim(),phone=(pts[1]||'').trim();
    const loan=+ins[3]?.value||0,rate=+ins[4]?.value||1.5;
    const sgv=+ins[5]?.value||0,egv=+ins[6]?.value||0;
    if(!bill||!cust||!loan)return;
    const d=gl('hand');d.push({id:nid(d),bill,date:dt,cust,phone,loan,rate,stat:'Open',repay:'',cg:autoCash(loan,sgv,egv),sg:sgv,eg:egv,ir:0,rc:0,rs:0,re:0});sl('hand',d);saved++;
  });
  // Gold + Hand Closed/Partial
  [['#bGC','gold'],['#bHC','hand']].forEach(([sel,key])=>{
    document.querySelectorAll(`${sel} .bf`).forEach(row=>{
      const billInput=row.querySelector('input:first-child');
      const billNo=billInput?.value.trim();
      if(!billNo)return;
      const laEl=row.querySelector('[id$="_la"]');
      const editable=[...row.querySelectorAll('input:not([readonly])')];
      const interest=+editable[0]?.value||0;
      const sgv=+editable[1]?.value||0;
      const egv=+editable[2]?.value||0;
      const statusSel=row.querySelector('select');
      const newStat=statusSel?statusSel.value:'Closed';
      const loanAmt=laEl?+laEl.value||0:0;
      const cashv=autoCash(loanAmt+interest,sgv,egv);
      const d=gl(key);
      const idx=d.findIndex(x=>x.bill.toLowerCase()===billNo.toLowerCase());
      if(idx>=0){
        d[idx]={...d[idx],stat:newStat};
        if(newStat==='Closed'){d[idx].rel=bdate;d[idx].repay=bdate;}
        // Add to existing interest received (partial payments accumulate)
        d[idx].ir=(+d[idx].ir||0)+interest;
        d[idx].rc=(+d[idx].rc||0)+cashv;
        d[idx].rs=(+d[idx].rs||0)+sgv;
        d[idx].re=(+d[idx].re||0)+egv;
      }else{
        const newR={id:nid(d),bill:billNo,date:bdate,cust:billNo,phone:'',loan:loanAmt,rate:1.5,stat:newStat,cg:0,sg:0,eg:0,ir:interest,rc:cashv,rs:sgv,re:egv};
        if(key==='gold')Object.assign(newR,{addr:'',items:'',gw:0,nw:0,rel:newStat==='Closed'?bdate:''});
        else newR.repay=newStat==='Closed'?bdate:'';
        d.push(newR);
      }
      sl(key,d);saved++;
    });
  });
  // Expenses
  document.querySelectorAll('#bExp .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const name=ins[0]?.value.trim(),amt=+ins[1]?.value||0;
    const cv=+ins[2]?.value||0,sgv=+ins[3]?.value||0,egv=+ins[4]?.value||0;
    if(!name||!amt)return;
    const d=gl('exp');d.push({id:nid(d),date:bdate,name,amt,cmt:'',co:cv||autoCash(amt,sgv,egv),so:sgv,eo:egv});sl('exp',d);saved++;
  });
  // Investments
  document.querySelectorAll('#bInv .bf').forEach(row=>{
    const ins=[...row.querySelectorAll('input')];
    const part=ins[0]?.value.trim(),amt=+ins[1]?.value||0;
    const cv=+ins[2]?.value||0,sgv=+ins[3]?.value||0,egv=+ins[4]?.value||0;
    if(!part||!amt)return;
    const d=gl('inv');d.push({id:nid(d),date:bdate,part,amt,stat:'Open',cmt:'',ci:cv||autoCash(amt,sgv,egv),si:sgv,ei:egv});sl('inv',d);saved++;
  });
  if(!saved)return toast('Nothing to save ‚Äî fill at least one row','err');
  clearBulk();renderAll();toast(`‚úÖ ${saved} transaction${saved>1?'s':''} saved!`,'ok');
}
function clearBulk(){
  ['bGold','bHand','bGC','bHC','bExp','bInv'].forEach(id=>$(id).innerHTML='');
  $('impC').innerHTML=$('impS').innerHTML=$('impE').innerHTML='<span class="neu">‚Çπ0</span>';
  addBR('g');addBR('h');addBR('gc');addBR('hc');addBR('e');addBR('i');
}

// ‚ïê‚ïê LEDGER ‚ïê‚ïê
function renderLed(){
  const from=v('lf'),to=v('lt');if(!from||!to)return;
  const prev=new Date(from);prev.setDate(prev.getDate()-1);const prevStr=prev.toISOString().split('T')[0];
  const ob=computeBal(prevStr);
  const txns=allTxns().filter(t=>t.date>=from&&t.date<=to);
  const cb={cash:ob.cash+txns.reduce((a,t)=>a+t.cash,0),sg:ob.sg+txns.reduce((a,t)=>a+t.sg,0),eg:ob.eg+txns.reduce((a,t)=>a+t.eg,0)};
  cb.total=cb.cash+cb.sg+cb.eg;
  const balBlock=(title,b)=>`<div class="lb"><div class="lb-t">${title} &nbsp;<span style="color:var(--txt3);font-weight:400">Total: ${INR(b.total)}</span></div>
    <div class="lb-g">
      <div class="lbc"><div class="lbc-l">üíµ Cash</div><div class="lbc-v">${INR(b.cash)}</div></div>
      <div class="lbc"><div class="lbc-l">üè¶ SG Phone</div><div class="lbc-v">${INR(b.sg)}</div></div>
      <div class="lbc"><div class="lbc-l">üè¶ EG Phone</div><div class="lbc-v">${INR(b.eg)}</div></div>
      <div class="lbc"><div class="lbc-l">Total</div><div class="lbc-v tot">${INR(b.total)}</div></div>
    </div></div>`;
  const rows=txns.length?txns.map(t=>`<div class="txi">
    <span style="color:var(--txt3)">${toDMY(t.date)}</span>
    <span class="txdir ${t.dir}">${t.dir==='in'?'‚ñ≤ IN':'‚ñº OUT'}</span>
    <span><div style="font-size:11px;color:var(--txt)">${t.type}</div><div style="font-size:9px;color:var(--txt3)">${t.desc}</div></span>
    <span class="amc ${t.dir==='in'?'pos':'neg'}">${t.dir==='in'?'+':'-'}${INR(Math.abs(t.total))}</span>
    <span class="amc ${t.cash===0?'neu':t.cash>0?'pos':'neg'}">${t.cash===0?'‚Äî':(t.cash>0?'+':'')+INR(t.cash)}</span>
    <span class="amc ${t.sg===0?'neu':t.sg>0?'pos':'neg'}">${t.sg===0?'‚Äî':(t.sg>0?'+':'')+INR(t.sg)}</span>
    <span class="amc ${t.eg===0?'neu':t.eg>0?'pos':'neg'}">${t.eg===0?'‚Äî':(t.eg>0?'+':'')+INR(t.eg)}</span>
  </div>`).join(''):`<div class="nd">No transactions in this date range.</div>`;
  const net=cb.total-ob.total;
  $('ledOut').innerHTML=`
    ${balBlock(`Opening Balance ‚Äî ${toDMY(from)}`,ob)}
    <div class="txl">
      <div class="txi txhdr"><span>Date</span><span>Dir</span><span>Description</span><span>Total</span><span>Cash</span><span>SG Phone</span><span>EG Phone</span></div>
      ${rows}
    </div>
    ${balBlock(`Closing Balance ‚Äî ${toDMY(to)}`,cb)}
    <div class="ls">
      <div class="ls-i"><label>Net Change</label><span style="color:${net>=0?'var(--g2)':'var(--r1)'}">${net>=0?'+':''}${INR(net)}</span></div>
      <div class="ls-i"><label>Total IN</label><span style="color:var(--g2)">${INR(txns.filter(t=>t.dir==='in').reduce((a,t)=>a+Math.abs(t.total),0))}</span></div>
      <div class="ls-i"><label>Total OUT</label><span style="color:var(--r1)">${INR(txns.filter(t=>t.dir==='out').reduce((a,t)=>a+Math.abs(t.total),0))}</span></div>
      <div class="ls-i"><label>Transactions</label><span>${txns.length}</span></div>
    </div>`;
}

// ‚ïê‚ïê ACCOUNTS ‚ïê‚ïê
function renderAcc(){
  const from=v('af'),to=v('at');
  const bal=computeBal();
  $('accCards').innerHTML=`
    <div class="ahc"><div class="ahc-lbl">üíµ Cash</div><div class="ahc-val">${INR(bal.cash)}</div><div class="ahc-sub">Current balance</div></div>
    <div class="ahc"><div class="ahc-lbl">üè¶ SG Phone Pay</div><div class="ahc-val">${INR(bal.sg)}</div><div class="ahc-sub">Current balance</div></div>
    <div class="ahc"><div class="ahc-lbl">üè¶ EG Phone Pay</div><div class="ahc-val">${INR(bal.eg)}</div><div class="ahc-sub">Current balance</div></div>`;
  // Transfer log
  const xfers=gl('xfer').filter(x=>(!from||x.date>=from)&&(!to||x.date<=to));
  if(xfers.length>0){
    $('accTransfers').innerHTML=`
      <div class="tc">
        <div class="tc-hd" style="background:var(--bp)">
          <h3 style="color:var(--b1)">‚áÑ Fund Transfers</h3>
          <span style="font-size:10px;color:var(--b1)">${xfers.length} transfer${xfers.length>1?'s':''}</span>
        </div>
        <div class="tw"><table>
          <thead><tr><th>Date</th><th>From</th><th>To</th><th>Amount ‚Çπ</th><th>Remarks</th><th>Actions</th></tr></thead>
          <tbody>${xfers.map(x=>`<tr>
            <td>${toDMY(x.date)}</td>
            <td><span class="badge bx">${lblAcc(x.from)}</span></td>
            <td><span class="badge bi">${lblAcc(x.to)}</span></td>
            <td><strong>${INR(x.amt)}</strong></td>
            <td>${x.rem||'‚Äî'}</td>
            <td><div style="display:flex;gap:4px">
              <button class="btn btn-b btn-sm" onclick="editTransfer(${x.id})">Edit</button>
              <button class="btn btn-r btn-sm" onclick="delTransfer(${x.id})">Del</button>
            </div></td>
          </tr>`).join('')}</tbody>
        </table></div>
      </div>`;
  } else {
    $('accTransfers').innerHTML='';
  }
  const txns=allTxns().filter(t=>(!from||t.date>=from)&&(!to||t.date<=to));
  $('accTbl').innerHTML=txns.length?txns.map(t=>{
    const isXfer=t.dir==='xfer';
    return`<tr>
      <td>${toDMY(t.date)}</td>
      <td>${t.type}</td>
      <td>${t.desc}</td>
      <td style="font-weight:700;color:${isXfer?'var(--b1)':t.dir==='in'?'var(--g1)':'var(--r1)'}">
        ${isXfer?'‚áÑ Transfer':t.dir==='in'?'+'+INR(Math.abs(t.total)):'-'+INR(Math.abs(t.total))}</td>
      <td style="color:${t.cash>0?'var(--g1)':t.cash<0?'var(--r1)':'var(--txt4)'}">${t.cash===0?'‚Äî':(t.cash>0?'+':'')+INR(Math.abs(t.cash))}</td>
      <td style="color:${t.sg>0?'var(--g1)':t.sg<0?'var(--r1)':'var(--txt4)'}">${t.sg===0?'‚Äî':(t.sg>0?'+':'')+INR(Math.abs(t.sg))}</td>
      <td style="color:${t.eg>0?'var(--g1)':t.eg<0?'var(--r1)':'var(--txt4)'}">${t.eg===0?'‚Äî':(t.eg>0?'+':'')+INR(Math.abs(t.eg))}</td>
      <td><span class="badge ${isXfer?'bo':t.dir==='in'?'bi':'bx'}">${isXfer?'XFER':t.dir==='in'?'IN':'OUT'}</span></td>
    </tr>`;
  }).join(''):`<tr><td colspan="8" class="nd">No transactions.</td></tr>`;
}

// ‚ïê‚ïê FUND TRANSFERS ‚ïê‚ïê
function openTM(){
  $('tId').value='';
  $('tDate').value=todayISO();
  $('tAmt').value='';
  $('tFrom').value='sg';
  $('tTo').value='cash';
  $('tRem').value='';
  $('tPreview').style.display='none';
  openM('tModal');
}
function editTransfer(xid){
  const x=gl('xfer').find(r=>r.id===xid);if(!x)return;
  $('tId').value=x.id;
  $('tDate').value=x.date;
  $('tAmt').value=x.amt;
  $('tFrom').value=x.from;
  $('tTo').value=x.to;
  $('tRem').value=x.rem||'';
  previewTransfer();
  openM('tModal');
}
function previewTransfer(){
  const amt=parseFloat($('tAmt').value)||0;
  const from=$('tFrom').value,to=$('tTo').value;
  if(!amt||from===to){$('tPreview').style.display='none';return;}
  const accIcon={cash:'üíµ Cash',sg:'üè¶ SG Phone',eg:'üè¶ EG Phone'};
  $('tPreview').style.display='block';
  $('tPreviewBody').innerHTML=`
    <div style="background:var(--rp);border-radius:8px;padding:10px">
      <div style="font-size:9px;color:var(--r1);font-weight:700;margin-bottom:3px">FROM</div>
      <div style="font-size:12px;font-weight:600;color:var(--r1)">${accIcon[from]}</div>
      <div style="font-size:16px;font-weight:700;color:var(--r1);margin-top:4px">-${INR(amt)}</div>
    </div>
    <div style="font-size:22px;color:var(--txt3)">‚Üí</div>
    <div style="background:var(--gp);border-radius:8px;padding:10px">
      <div style="font-size:9px;color:var(--g2);font-weight:700;margin-bottom:3px">TO</div>
      <div style="font-size:12px;font-weight:600;color:var(--g2)">${accIcon[to]}</div>
      <div style="font-size:16px;font-weight:700;color:var(--g2);margin-top:4px">+${INR(amt)}</div>
    </div>`;
}
function saveTransfer(){
  const eid=$('tId').value;
  const amt=parseFloat($('tAmt').value)||0;
  const from=$('tFrom').value,to=$('tTo').value;
  if(!amt)return toast('Enter transfer amount','err');
  if(from===to)return toast('From and To accounts must be different','err');
  const obj={id:eid?+eid:nid(gl('xfer')),date:v('tDate'),from,to,amt,rem:v('tRem').trim()};
  let data=gl('xfer');
  if(eid)data=data.map(r=>r.id===+eid?obj:r);else data.push(obj);
  sl('xfer',data);closeM('tModal');renderAcc();renderDB();
  toast(`‚úÖ Transfer of ${INR(amt)} saved!`,'ok');
}
function delTransfer(xid){
  if(!confirm('Delete this transfer?'))return;
  sl('xfer',gl('xfer').filter(r=>r.id!==xid));
  renderAcc();renderDB();toast('Transfer deleted.');
}

// ‚ïê‚ïê IMPORT ‚ïê‚ïê
function handleDrop(e){e.preventDefault();$('dropZone').classList.remove('drag');const f=e.dataTransfer.files[0];if(f)handleFile(f);}
function handleFile(file){
  if(!file||!file.name.endsWith('.xlsx'))return toast('Please upload a .xlsx file','err');
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array',cellDates:false});
      let imported={gold:0,hand:0,inv:0,exp:0};

      // Convert any cell value to ISO date string YYYY-MM-DD
      function toDate(val){
        if(!val&&val!==0)return '';
        const s=String(val).trim();
        if(!s||s==='None')return '';
        // Excel serial number (5 digit number)
        if(/^\d{5}$/.test(s)){
          const d=new Date(Math.round((+s-25569)*86400*1000));
          return d.toISOString().split('T')[0];
        }
        // datetime string like "2026-02-20 00:00:00"
        if(s.includes(' ')&&s.includes('-'))return s.split(' ')[0];
        // DD-MM-YYYY or DD/MM/YYYY
        const p=s.split(/[-\/]/);
        if(p.length===3){
          if(p[2].length===4)return `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
          if(p[0].length===4)return s; // already YYYY-MM-DD
        }
        return s;
      }

      // Safe string
      function str(v){const s=String(v||'').trim();return(s==='None'||s==='undefined')?'':s;}
      // Safe number
      function num(v){const n=parseFloat(v);return isNaN(n)?0:n;}
      // Is a hint/example row? (first cell starts with "e.g" or "DD-" or "Plain" or "Open or")
      function isHint(r){const c=str(r[0]);return c.startsWith('e.g')||c.startsWith('DD-')||c.startsWith('Plain')||c.startsWith('Open or')||c.startsWith('Enter')||c.startsWith('Leave');}

      // ‚îÄ‚îÄ GOLD LOANS ‚îÄ‚îÄ
      // Sheet: "Gold Loans"
      // Row 0: Title, Row 1: Headers, Row 2: Hints, Row 3+: Data
      // Cols: 0=BillNo, 1=Date, 2=Customer, 3=Address, 4=Phone, 5=Items,
      //       6=GrossWt, 7=NetWt, 8=LoanAmt, 9=Rate, 10=Status,
      //       11=ReleaseDate, 12=InterestReceived, 13=CashGiven, 14=SGGiven, 15=EGGiven,
      //       16=CashReceivedBack, 17=SGReceived, 18=EGReceived
      const gws=wb.Sheets['Gold Loans']||wb.Sheets['BillDetails'];
      if(gws){
        const rows=XLSX.utils.sheet_to_json(gws,{header:1,defval:'',raw:true});
        const data=[];
        for(let i=0;i<rows.length;i++){
          const r=rows[i];
          const bill=str(r[0]);
          if(!bill)continue;              // skip empty rows
          if(i===0)continue;              // skip title row
          if(bill==='Bill No')continue;   // skip header row
          if(isHint(r))continue;          // skip hint row
          const cust=str(r[2]);
          if(!cust)continue;
          const loan=num(r[8]);
          const sg=num(r[14]),eg=num(r[15]),cash=num(r[13])||autoCash(loan,sg,eg);
          const rSG=num(r[17]),rEG=num(r[18]),rCash=num(r[16])||autoCash(loan+num(r[12]),rSG,rEG);
          data.push({
            id:data.length+1,
            bill,date:toDate(r[1]),cust,
            addr:str(r[3]),phone:str(r[4]),items:str(r[5]),
            gw:num(r[6]),nw:num(r[7]),loan,rate:num(r[9])||1.5,
            stat:str(r[10])||'Open',
            cg:cash,sg,eg,
            rel:toDate(r[11]),ir:num(r[12]),
            rc:rCash,rs:rSG,re:rEG
          });
          imported.gold++;
        }
        if(data.length>0)sl('gold',data);
      }

      // ‚îÄ‚îÄ HAND LOANS ‚îÄ‚îÄ
      // Sheet: "Hand Loans"
      // Cols: 0=BillNo, 1=Date, 2=Customer, 3=Phone, 4=LoanAmt, 5=Rate,
      //       6=Status, 7=RepayDate, 8=InterestReceived,
      //       9=CashGiven, 10=SGGiven, 11=EGGiven,
      //       12=CashReceivedBack, 13=SGReceived, 14=EGReceived
      const hws=wb.Sheets['Hand Loans']||wb.Sheets['HandLoans'];
      if(hws){
        const rows=XLSX.utils.sheet_to_json(hws,{header:1,defval:'',raw:true});
        const data=[];
        for(let i=0;i<rows.length;i++){
          const r=rows[i];
          const bill=str(r[0]);
          if(!bill)continue;
          if(i===0)continue;
          if(bill==='Bill No')continue;
          if(isHint(r))continue;
          const cust=str(r[2]);
          if(!cust)continue;
          const loan=num(r[4]);
          const sg=num(r[10]),eg=num(r[11]),cash=num(r[9])||autoCash(loan,sg,eg);
          const rSG=num(r[13]),rEG=num(r[14]),rCash=num(r[12])||autoCash(loan+num(r[8]),rSG,rEG);
          data.push({
            id:data.length+1,
            bill,date:toDate(r[1]),cust,phone:str(r[3]),
            loan,rate:num(r[5])||1.5,
            stat:str(r[6])||'Open',repay:toDate(r[7]),
            cg:cash,sg,eg,
            ir:num(r[8]),rc:rCash,rs:rSG,re:rEG
          });
          imported.hand++;
        }
        if(data.length>0)sl('hand',data);
      }

      // ‚îÄ‚îÄ INVESTMENTS ‚îÄ‚îÄ
      // Sheet: "Investments"
      // Cols: 0=Date, 1=PartnerName, 2=Amount, 3=Status, 4=CashReceived, 5=SGReceived, 6=EGReceived, 7=Comments
      const iws=wb.Sheets['Investments'];
      if(iws){
        const rows=XLSX.utils.sheet_to_json(iws,{header:1,defval:'',raw:true});
        const data=[];
        for(let i=0;i<rows.length;i++){
          const r=rows[i];
          const partner=str(r[1]);
          if(!partner)continue;
          if(i===0)continue;
          if(partner==='Partner Name')continue;
          if(isHint(r))continue;
          const amt=num(r[2]);
          if(!amt)continue;
          data.push({
            id:data.length+1,
            date:toDate(r[0]),part:partner,amt,
            stat:str(r[3])||'Open',
            ci:num(r[4])||autoCash(amt,num(r[5]),num(r[6])),
            si:num(r[5]),ei:num(r[6]),
            cmt:str(r[7])
          });
          imported.inv++;
        }
        if(data.length>0)sl('inv',data);
      }

      // ‚îÄ‚îÄ EXPENSES ‚îÄ‚îÄ
      // Sheet: "Expenses"
      // Cols: 0=Date, 1=ExpenseName, 2=Amount, 3=CashPaid, 4=SGPaid, 5=EGPaid, 6=Comments
      const ews=wb.Sheets['Expenses'];
      if(ews){
        const rows=XLSX.utils.sheet_to_json(ews,{header:1,defval:'',raw:true});
        const data=[];
        for(let i=0;i<rows.length;i++){
          const r=rows[i];
          const name=str(r[1]);
          if(!name)continue;
          if(i===0)continue;
          if(name==='Expense Name')continue;
          if(isHint(r))continue;
          const amt=num(r[2]);
          if(!amt)continue;
          data.push({
            id:data.length+1,
            date:toDate(r[0]),name,amt,
            co:num(r[3])||autoCash(amt,num(r[4]),num(r[5])),
            so:num(r[4]),eo:num(r[5]),
            cmt:str(r[6])
          });
          imported.exp++;
        }
        if(data.length>0)sl('exp',data);
      }

      const total=imported.gold+imported.hand+imported.inv+imported.exp;
      $('impResult').style.display='block';
      $('impResult').innerHTML=`<div style="font-size:12px;font-weight:700;color:var(--g1);margin-bottom:8px">‚úÖ Import Complete ‚Äî ${total} records loaded</div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:7px;font-size:12px">
          <div>ü•á Gold Loans: <strong>${imported.gold}</strong></div>
          <div>ü§ù Hand Loans: <strong>${imported.hand}</strong></div>
          <div>üìà Investments: <strong>${imported.inv}</strong></div>
          <div>üßæ Expenses: <strong>${imported.exp}</strong></div>
        </div>`;
      renderAll();toast(`‚úÖ ${total} records imported!`,'ok');
    }catch(err){toast('Error reading file ‚Äî check format','err');console.error(err);}
  };
  reader.readAsArrayBuffer(file);
}

// ‚ïê‚ïê BACKUP ‚ïê‚ïê
function updateCounts(){
  const g=gl('gold').length,h=gl('hand').length,inv=gl('inv').length,ex=gl('exp').length;
  $('goldCnt').textContent=`${g} records`;$('handCnt').textContent=`${h} records`;
  $('invCnt').textContent=`${inv} records`;$('expCnt').textContent=`${ex} records`;
  $('totalCount').textContent=`${g+h+inv+ex} records total`;
}
function exportAll(){
  const wb=XLSX.utils.book_new();
  buildGoldSheet(wb);buildHandSheet(wb);buildInvSheet(wb);buildExpSheet(wb);
  XLSX.writeFile(wb,`Mani_Backup_${todayISO()}.xlsx`);toast('‚úÖ Full backup downloaded!','ok');
}
function exportSheet(key){
  const wb=XLSX.utils.book_new();
  if(key==='gold')buildGoldSheet(wb);else if(key==='hand')buildHandSheet(wb);else if(key==='inv')buildInvSheet(wb);else buildExpSheet(wb);
  const names={gold:'Gold_Loans',hand:'Hand_Loans',inv:'Investments',exp:'Expenses'};
  XLSX.writeFile(wb,`Mani_${names[key]}_${todayISO()}.xlsx`);toast(`‚úÖ ${names[key]} exported!`,'ok');
}
function buildGoldSheet(wb){
  const h=['Bill No','Bill Date','Customer Name','Customer Address','Phone','Items','Gross Wt(g)','Net Wt(g)','Loan Amount(‚Çπ)','Interest Rate(%)','Status','Release Date','Interest Received(‚Çπ)','Cash Given(‚Çπ)','SG Phone Given(‚Çπ)','EG Phone Given(‚Çπ)','Cash Received(‚Çπ)','SG Phone Received(‚Çπ)','EG Phone Received(‚Çπ)'];
  const ws=XLSX.utils.aoa_to_sheet([h,...gl('gold').map(x=>[x.bill,toDMY(x.date),x.cust,x.addr,x.phone,x.items,x.gw,x.nw,x.loan,x.rate,x.stat,toDMY(x.rel)||'',x.ir||0,x.cg||0,x.sg||0,x.eg||0,x.rc||0,x.rs||0,x.re||0])]);
  XLSX.utils.book_append_sheet(wb,ws,'Gold Loans');
}
function buildHandSheet(wb){
  const h=['Bill No','Loan Date','Customer Name','Phone','Loan Amount(‚Çπ)','Interest Rate(%)','Status','Repay Date','Interest Received(‚Çπ)','Cash Given(‚Çπ)','SG Phone Given(‚Çπ)','EG Phone Given(‚Çπ)','Cash Received(‚Çπ)','SG Phone Received(‚Çπ)','EG Phone Received(‚Çπ)'];
  const ws=XLSX.utils.aoa_to_sheet([h,...gl('hand').map(x=>[x.bill,toDMY(x.date),x.cust,x.phone,x.loan,x.rate,x.stat,toDMY(x.repay)||'',x.ir||0,x.cg||0,x.sg||0,x.eg||0,x.rc||0,x.rs||0,x.re||0])]);
  XLSX.utils.book_append_sheet(wb,ws,'Hand Loans');
}
function buildInvSheet(wb){
  const h=['Date','Partner Name','Amount(‚Çπ)','Status','Cash Received(‚Çπ)','SG Phone Received(‚Çπ)','EG Phone Received(‚Çπ)','Comments'];
  const ws=XLSX.utils.aoa_to_sheet([h,...gl('inv').map(x=>[toDMY(x.date),x.part,x.amt,x.stat,x.ci||0,x.si||0,x.ei||0,x.cmt||''])]);
  XLSX.utils.book_append_sheet(wb,ws,'Investments');
}
function buildExpSheet(wb){
  const h=['Date','Expense Name','Amount(‚Çπ)','Cash Paid(‚Çπ)','SG Phone Paid(‚Çπ)','EG Phone Paid(‚Çπ)','Comments'];
  const ws=XLSX.utils.aoa_to_sheet([h,...gl('exp').map(x=>[toDMY(x.date),x.name,x.amt,x.co||0,x.so||0,x.eo||0,x.cmt||''])]);
  XLSX.utils.book_append_sheet(wb,ws,'Expenses');
}
function exportLedger(){
  const from=v('lf'),to=v('lt');if(!from||!to)return toast('Select date range first','err');
  const txns=allTxns().filter(t=>t.date>=from&&t.date<=to);
  const ws=XLSX.utils.aoa_to_sheet([['Date','Direction','Type','Description','Total(‚Çπ)','Cash(‚Çπ)','SG Phone(‚Çπ)','EG Phone(‚Çπ)'],
    ...txns.map(t=>[toDMY(t.date),t.dir==='in'?'IN':'OUT',t.type,t.desc,t.dir==='in'?+Math.abs(t.total):-Math.abs(t.total),t.cash,t.sg,t.eg])]);
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Ledger');
  XLSX.writeFile(wb,`Mani_Ledger_${from}_to_${to}.xlsx`);toast('‚úÖ Ledger exported!','ok');
}

// ‚ïê‚ïê SETTINGS ‚ïê‚ïê
function initDates(){
  const t=todayISO();const d=new Date();d.setDate(1);const f=d.toISOString().split('T')[0];
  $('bulkDate').value=t;$('lf').value=f;$('lt').value=t;$('af').value=f;$('at').value=t;
}
function loadSettings(){
  $('cfgUrl').value=CFG.url||'';$('cfgKey').value=CFG.key||'';
  $('obC').value=CFG.obC||0;$('obS').value=CFG.obS||0;$('obE').value=CFG.obE||0;$('obD').value=CFG.obD||todayISO();
  $('sqlBox').textContent=`-- Mani Finance ‚Äî Supabase Setup / Migration\n-- Run in Supabase SQL Editor. Safe to run multiple times.\n\ncreate table if not exists gold_loans (id bigint primary key,bill text,date text,cust text,addr text,phone text,items text,gw numeric default 0,nw numeric default 0,loan numeric default 0,rate numeric default 1.5,stat text default 'Open',cg numeric default 0,sg numeric default 0,eg numeric default 0,rel text,ir numeric default 0,rc numeric default 0,rs numeric default 0,re numeric default 0);\ncreate table if not exists hand_loans (id bigint primary key,bill text,date text,cust text,phone text,loan numeric default 0,rate numeric default 1.5,stat text default 'Open',repay text,ir numeric default 0,cg numeric default 0,sg numeric default 0,eg numeric default 0,rc numeric default 0,rs numeric default 0,re numeric default 0);\ncreate table if not exists investments (id bigint primary key,date text,part text,amt numeric default 0,stat text default 'Open',cmt text,ci numeric default 0,si numeric default 0,ei numeric default 0);\ncreate table if not exists expenses (id bigint primary key,date text,name text,amt numeric default 0,cmt text,co numeric default 0,so numeric default 0,eo numeric default 0);\ncreate table if not exists fund_transfers (id bigint primary key,date text,from_acc text,to_acc text,amt numeric default 0,rem text);\n\nalter table gold_loans enable row level security;\nalter table hand_loans enable row level security;\nalter table investments enable row level security;\nalter table expenses enable row level security;\nalter table fund_transfers enable row level security;\n\ndrop policy if exists "allow_all" on gold_loans;\ndrop policy if exists "allow_all" on hand_loans;\ndrop policy if exists "allow_all" on investments;\ndrop policy if exists "allow_all" on expenses;\ndrop policy if exists "allow_all" on fund_transfers;\n\ncreate policy "allow_all" on gold_loans for all using (true) with check (true);\ncreate policy "allow_all" on hand_loans for all using (true) with check (true);\ncreate policy "allow_all" on investments for all using (true) with check (true);\ncreate policy "allow_all" on expenses for all using (true) with check (true);\ncreate policy "allow_all" on fund_transfers for all using (true) with check (true);`;
}
async function saveConfig(){
  CFG.url=v('cfgUrl').trim().replace(/\/$/,'');CFG.key=v('cfgKey').trim();
  localStorage.setItem('fs_cfg',JSON.stringify(CFG));
  const st=$('cfgSt');st.textContent='Testing‚Ä¶';st.style.color='var(--txt3)';
  if(CFG.url&&CFG.key){
    try{
      const r=await fetch(`${CFG.url}/rest/v1/gold_loans?limit=1`,{headers:{'apikey':CFG.key,'Authorization':'Bearer '+CFG.key}});
      if(r.ok){
        st.textContent='‚úÖ Connected! Pulling data from cloud‚Ä¶';st.style.color='var(--g2)';
        const pulled=await sbPull();
        if(pulled){
          renderAll();
          st.textContent='‚úÖ Connected & synced! All devices will now share the same data.';
        }else{
          // No cloud data yet ‚Äî push local data up
          for(const k of Object.keys(TABLES)){
            const d=gl(k);if(d.length>0)await sbPush(k,d);
          }
          st.textContent='‚úÖ Connected! Local data pushed to cloud. All devices now in sync.';
        }
        st.style.color='var(--g2)';
      }
      else{st.textContent='‚ùå Failed ‚Äî check URL/key and run SQL script first.';st.style.color='var(--r1)';}
    }catch(e){st.textContent='‚ö†Ô∏è Network error ‚Äî check your URL.';st.style.color='var(--y1)';}
  }else{st.textContent='Saved. Add URL & Key to enable cross-device sync.';st.style.color='var(--txt3)';}
}
function saveOB(){CFG.obC=n('obC');CFG.obS=n('obS');CFG.obE=n('obE');CFG.obD=v('obD');localStorage.setItem('fs_cfg',JSON.stringify(CFG));renderDB();toast('Opening balances saved!','ok');}

function savePW(){const p1=v('pw1').trim(),p2=v('pw2').trim();if(p1)CFG.pw1=p1;if(p2)CFG.pw2=p2;localStorage.setItem('fs_cfg',JSON.stringify(CFG));$('pw1').value='';$('pw2').value='';toast('Passwords updated!','ok');}
function copySql(){navigator.clipboard.writeText($('sqlBox').textContent).then(()=>toast('SQL copied!','ok')).catch(()=>toast('Select text manually','err'));}

// ‚ïê‚ïê INIT ‚ïê‚ïê
checkSession();
</script>
</body>
</html>
